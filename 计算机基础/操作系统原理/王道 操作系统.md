
# 计算机系统概述

## 操作系统基本概念

### 操作系统概念

操作系统管理计算机硬件资源，为应用程序提供基础，充当计算机硬件与用户之间的中介。

操作系统是**程序集合**，是计算机系统中**最基本的系统软件**。

> 系统软件是指直接控制和管理计算机硬件资源、提供用户与计算机交互界面以及为应用软件提供运行环境的软件。它包括操作系统、设备驱动程序、诊断工具、服务器软件、窗口系统和实用程序等。


---


<br/>

### 操作系统特征

**并发和共享是最基本的特征**
- 共享以并发为基础
- 若不能对资源共享进行有效管理，会影响程序的并发执行

<br/>


**并发**

多个事件在同一时间间隔内发生。

<br/>


**共享**
- 互斥共享：**一段时间**只允许一个进程访问。打印机、磁带机。
- 同时共享：磁盘设备。

<br/>


**虚拟**
- 时分复用技术：例如多道程序设计技术
- 空分复用技术：虚拟存储器技术

<br/>


**异步**

进程的执行以不可预知的速度前进。

---

<br/>

### 操作系统目的与功能

**计算机系统资源的管理者**

- 处理机管理：处理机的分配和运行以进程（线程）为单位，可以归结为进程管理
- 存储器管理：内存的管理
- 文件管理
- 设备管理

<br/>


**用户与计算机硬件系统之间的接口**

- 命令接口：
	- 脱机命令接口：一条命令一条命令的输入，然后执行、反馈。交互性
	- 联机命令接口
- 程序接口：系统调用

<br/>


**计算机资源的扩充**

- 裸机
- 扩充机器（虚拟机）：覆盖了软件的机器

---

<br/>


<br/>



## 操作系统发展历程

**手工阶段**

无操作系统

<br/>


**批处理阶段（操作系统开始出现）**
- 单道批处理：**内存中仅存放一道作业**
- 多道批处理：内存中可以存放多道作业，在一道作业阻塞时，另一道作业执行。

<br/>


**分时操作系统**

按照时间片轮转执行

<br/>


**实时操作系统**
- 硬实时：动作必须在规定时间（或时间段）内**发生**
- 软实时：可以偶尔违反时间规定，而不引起永久性损害。

<br/>


**网络操作系统与分布系统操作系统**
- 网络操作系统：强调网络中各种资源的共享和各台计算机之间的通信。
- 分布式操作系统：**一个任务**可以分布在几台计算上，**并行工作**，协作完成。

---

<br/>


<br/>



## 操作系统运行环境

### 处理器运行模式

**特权指令与非特权指令**
- 特权指令：只能在内核态执行的指令，I/O 指令、关中断指令、内存清零指令、存取用于内存保护的寄存器、送 PSW 到程序状态字寄存器。
- 非特权指令：这类指令不会涉及对系统状态或资源的直接修改。

> 这里的指令通常指的是 汇编指令 或 机器指令。这些指令直接与处理器交互，控制硬件的操作。
> 
> 访存指令 load（加载指令）一般属于 非特权指令。虽然 load 指令本身是非特权指令，但用户程序只能访问自己拥有权限的内存区域。如果试图通过 load 指令访问未授权的内存地址（比如内核空间），处理器会触发异常，防止非法操作。


<br/>

**用户态与内核态**

- 用户态：应用程序需要请求操作系统服务时，通过**访管指令**（非特权指令）。
- 内核态：操作系统**内核程序运行在内核态**。由内核态返回用户态，一般通过**中断返回指令**。


> 
虽然用户态与核心态之间的切换在硬件层面只是通过设置寄存器标志来完成，但实际的开销远不止这一点。
> - 保存和恢复上下文：从用户态切换到核心态时，系统需要保存当前进程的上下文。
> - 缓存失效：访问不同的内存区域（如内核代码和用户代码、内核数据和用户数据），可能会导致 Cache 和快表失效。
> - 内存映射切换：内核态和用户态可能使用不同的页表（管理内存的映射）。在态切换时，可能需要调整页表，导致页表的更新或刷新。这也增加了系统的开销。


<br/>

**操作系统内核**

- 时钟管理
- 中断机制：只有一小部分属于内核，辅助保护和恢复中断现场的信息，转移控制权。
- 原语
- 系统控制的数据结构 以及 处理

---

<br/>

### 中断和异常的概念

当发生中断和异常时，CPU 会进入内核态（**通过硬件实现**，例如，通过一个特殊的寄存器了表示 CPU 所处的工作状态）。

<br/>

中断（外中断）：由与指令指令执行无关的外部事件引起，需要通过请求线来通知 CPU。
- 可屏蔽中断：通过 INTR 线发出请求。
- 不可屏蔽中断：通过 NMI 线发出请求，通常是紧急的硬件故障，如电源掉电。

异常（内中断）：由于指令的执行引起
- 故障：非法操作码、除零、缺页
- 自陷：条件陷阱、系统调用
- 终止：硬件故障，控制器出错、存储器校验错

---

<br/>

### 系统调用

凡是与**系统资源有关**的操作（存储分配、I/O 传输、文件管理）都必须通过系统调用方式向操作系统提出服务请求。系统调用的处理由于操作系统**内核程序**完成，在内核态。

<br/>


**系统调用的处理过程**
- 系统调用号和所需参数压入栈
- 陷入指令，用户态转为内核态
- 保护被中断进程的现场
- 转入相应的系统调用处理程序（根据系统调用号来找到入口地址）
- 恢复现场
- 返回被中断进程

---


<br/>


<br/>

## 操作系统结构

**分层法**

底层为硬件，顶层为用户接口。**每层只能调用紧挨其的低一层的服务**。

优点：
- 方便系统调试和验证。一层一层的调试，当某一层发生错误，不用检查底下的层。
- 易于扩充和维护，增加、修改、替换某一层时，只要不改变接口，就不会影响其他层。

缺点：
- 定义各层比较困难
- 效率较差：没执行一个功能要从上向下穿过多层


<br/>

**模块化**

按照功能划分为具有一定独立性的模块。

优点：
- 提高操作系统设计的准确性、可理解性、可维护性
- 增强操作系统的可适应性
- 操作操作系统开发过程

缺点：
- 模块间接口规定很难满足对接口的实际需求
- 各模块设计者齐头并进，决定无法建立在上一个已验证的正确基础之上


<br/>

**宏内核**

将系统**主要功能模块**作为一个紧密联系的整体运行在核心态。

目前主流的操作系统都是基于宏内核的架构（并非纯粹的宏内核，而是吸收了微内核优点的混合内核）。


<br/>

**微内核**

将内核中**最基本的功能**留在内核，其余移到用户态执行，移出内核的操作系统代码根据分层原则被划分为若干**服务程序**。**服务程序之间借助微内核进行通信**。

微内核包含：
- 与硬件密切相关的部分
- 较基本的功能
- 客户与服务器之间的通信。提供消息传递机制。

微内核功能：
- 进程管理。微内核之外有进程管理服务器，用于对用户进程进行分类，确定优先级。
- 低级存储器管理：最基本的管理机制，如实现逻辑地址到物理地址转换的页表机制和地址变换机制。
- 中断和陷入处理：捕获发生的中断或陷入事件，识别之后，交给对应的服务程序进行处理。

微内核特点：
- 拓展性与灵活性
- 可靠性与安全性
- 可移植性：与硬件有关的代码放在内核
- 分布式计算：采用消息传递机制，很好支持分布式和网络系统
- 存在性能问题：频繁在核心态和用户态之间进行切换

微内核在实时、工业、航空以及军事应用中特别流行。


<br/>

**外核**

外核程序运行在内核态，负责对硬件资源进行分配、回收、保护。

---


<br/>


<br/>


## 操作系统引导

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-08-26_111206.png" width="600" />
</center>


---

<br/>


<br/>

## 虚拟机

**第一类虚拟机管理程序**

虚拟管理程序就像是操作系统，而虚拟机像是一个进程。

当虚拟机操作系统执行了一条内核态才运行执行的指令，陷入虚拟机管理程序，在支持虚拟化的 CPU 上，检查指令是由系统执行还是用户执行：
- 系统执行：虚拟机管理程序安排指令的正确执行。
- 用户执行：模拟真实硬件面对用户态执行敏感指令的行为。

在不支持虚拟化的 CPU 上，不会直接执行虚拟机的敏感指令，而是转为对于虚拟机管理程序的调用，由虚拟机管理程序模拟指令的功能。


<br/>

**第二类虚拟机管理程序**

虚拟机管理程序本身像是一个进程， 依赖于 宿主操作系统分配和调度资源。

VMware Workstation 是 x 86 平台上收个第二类虚拟机管理程序。


---

<br/>


<br/>


<br/>

# 进程 与 线程

## 进程与线程介绍

### 进程概念与特征

**进程的概念**

在多道程序环境下，运行多个程序并发执行。程序失去封闭性，具有间断性和不可再现性。

> **封闭性**：执行结果只取决于进程本身，不受外界影响。

> **不可再现性**：并发进程存在相互竞争与制约，每次执行结果可能不一样。


因此引入了进程的概念，**进程实体**由三部分组成：
- 进程控制块 PCB：描述进程的基本情况和运行状态的数据结构
- 程序段
- 数据段

进程是进程实体的运行过程，是系统进行**资源分配**和**调度**的基本单位。


<br/>

**进程的特征**

- 动态性：进程是程序的一次执行
- 并发性
- 独立性
- 异步性

---

<br/>

### 进程的组成

**进程控制块 PCB**

PCB 在创建之后常驻于内存，是进程存在的唯一标志，系统通过 PCB 对进程进行控制（系统通过 PCB 才能感知到该进程的存在），PCB 的组成如下：
- 进程描述信息：PID，UID（用户标识符，主要为共享和保护提供服务）
- 进程控制与管理信息：进程当前状态、优先级、代码入口地址、程序外存地址、CPU 占用时间等
- 资源分配清单：代码段指针、数据段指针、堆栈段指针
- 处理机相关信息：CPU 各寄存器的值

各个进程 PCB 的组织方式：
- 链接方式：相同状态的 PCB 链接成一个列表
- 索引方式：相同状态的 PCB 组织在一个索引表里面


<br/>

**程序段**

即代码段。多个进程可以运行同一个程序。


<br/>

**数据段**

加工处理的原始数据；执行时产生的中间与最终结果。

---

<br/>

### 进程的状态 与 转换
通常有 5 种状态，运行、就绪、阻塞是 **基本状态**

- 运行态：进程正在 CPU 运行。
- 就绪态：获得了除了 CPU 时间片以外的一切所需资源，等待调度运行。
- 阻塞态：等待某个资源（不包括 CPU 时间片）可以用，或者 I/O 完成。
- 创建态：正在被创建，需要完成以下步骤
	- 申请空白 PCB
	- 向 PCB 写入信息
	- 分配运行时所需资源
	- 将进程转入就绪态，并插入队列
- 终止态


<br/>

进程状态转换：
- 就绪  ---> 运行：被调度，获得 CPU 资源
- 运行  ---> 就绪：时间片用完，或者时间片被跟高优先级进程抢占
- 运行  ---> 阻塞：这是**进程的主动行为**。进程执行 wait 操作，进入休眠，或者等待 I/O 
- 阻塞  ---> 就绪：**进程的被动行为**，需要其他进程协助。

---

<br/>

### 进程控制

一般将进程控制用的程序段称为**原语**。

**进程创建**

进程可以创建子进程，子进程继承父进程所拥有的资源，当子进程被撤销时，获得的资源归还给父进程，父进程撤销时，通常会撤销其所有子进程。

> 当一个进程（父进程）创建一个新的进程（子进程）时，子进程会继承父进程的以下资源：
> 
> - **文件描述符**：子进程会继承父进程打开的所有文件描述符。这意味着子进程可以访问父进程能够访问的所有文件和设备。
> - **环境变量**：子进程继承父进程的环境变量，这包括操作系统提供的各种环境设置，如语言环境、用户信息等。
> - **执行代码**：子进程继承父进程的程序代码，即它们执行的是相同的程序。
> - **堆和栈**：子进程会**复制**父进程的堆和栈的初始状态，但它们是**独立的**，子进程的任何修改都不会影响到父进程。
> - **全局变量**：如果父进程有全局变量，子进程也会继承这些变量的初始值，但它们在子进程中的修改**不会影响到父进程中的全局变量**。
> - **信号处理**：子进程会继承父进程的信号处理设置。
> - **进程 ID**：子进程会获得一个新的进程 ID，但其他一些标识符，如用户 ID 和组 ID，可能会继承自父进程。
> - **内存映射**：子进程会继承父进程的内存映射，包括共享库和动态内存分配。
> - **网络连接**：如果父进程有建立的网络连接，子进程可能会继承这些连接，这取决于具体的操作系统和网络 API。
> 
> 需要注意的是，虽然子进程继承了父进程的许多资源，但它们是两个独立的进程，拥有自己的地址空间和执行控制流。子进程的执行不会影响到父进程，除非它们通过某种方式进行进程间通信（IPC）。此外，操作系统通常提供了一些机制来控制子进程继承资源的行为，如在 Unix-like 系统中使用 fork 函数时配合 exec 系列函数来避免继承某些资源。

创建进程的原因：
- 终端用户登录：系统需要创建一个用户管理的进程
- 高级调度
- 系统处理用户程序的请求：运行处理进程
- 用户程序的应用请求

创建新进程时的操作：
- 分配 PID，申请一个空白的 PCB。**如果 PCB 申请失败，则创建失败**。
- 分配运行所需资源。**如果资源不足，则处于继续处于创建态**，等待资源，而不是创建失败。
- 初始化 PCB
- 插入就绪队列


<br/>

**进程终止**

引起进程终止的事件：
- 正常结束
- 异常结束
- 外界干预

终止进程操作：
- 根据 PCB 读取进程状态：
	- 如果处于运行态，这终止进程执行
	- 如果进程有子进程，则**通常将其所有子进程终止**
- 将进程所拥有的全部资源，归还给父进程或操作系统
- 将 PCB 从队列中删除


<br/>

**进程阻塞与唤醒**

调用**阻塞原语**进入阻塞态；使用**唤醒原语**将等待该事件的进程唤醒。


---

<br/>

### 进程通信

PV 操作时低级通信方式。高级通信方式是以**较高效率**传输**大量数据**的通信方式：

**共享存储**

通过一块可以直接访问的共享空间，进行数据交换，是三种方式中**速度最快**的一种。需要使用 PV 操作对共享空间的读写进行控制。
- 低级方式共享：基于数据结构
- 高级方式共享：基于存储区

通过系统调用实现。


<br/>

**消息传递**

