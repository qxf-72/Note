<div align="center"> <img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/caa0952d0bfdfb0e3a7b7e846c596ea.jpg" width = 600 /> </div>

# 概述

## 信息时代概述

21世纪的一些重要特征就是数字化、网络化和信息化，它是一个以网络为核心的时代。

三类常见网络：电信网络、有线电视网络和计算机网络。

互联网的两个基本特点
- 连通性：互联网用户之间可以交换数据，应当注意互联网具有虚拟性
- 共享：即资源共享

---

<br/>


<br/>


## 互联网概述

### 基本概念

计算机网络：简称网络，由若干个节点（node）和连接这些结点的链路（link）组成。与网络相连的计算机常称为主机。

互**连**网（internet）：是一个通用名词，泛指多个计算机网络互相连接而成的计算机网络（网络的网络），在这些网络之间的通信协议可以任意选择。

互**联**网（Internet）：是一个专用名词，指当前全球最大的、开放的、由众多网络相互连接而成的特定互连网，采用 TCP/IP 协议作为通信的规则。

---

<br/>


### 互连网的发展

1. 从单个网络 ARPANET 向互连网发展的过程。
2. 建成三级结构的互联网——主干网、地区网和校园网（企业网）。
3. 逐渐形成全球范围的多层次的 ISP 结构的互联网。
   - ISP（Internet Service Provider）互联网服务提供商：从互联网管理结构申请到很多 IP 地址，同时拥有通信新路以及路由器等连网设备
   - IP 管理结构不会把单个 IP 地址零星分配为单个用户，而是整块 IP 地址租赁给 ISP。
   - 结构或个人只要向某个 ISP 缴费就可以获取 IP 地址接入互联网。
   - ISP 也可以分为不同层次：
      - 主干 ISP——由几个专门的公司创建和维护，服务面积大。
      - 地区 ISP——用过一个或多个主 ISP 连接起来。
      - 本地 ISP——给用户提供直接的服务。

互联网交换点 IXP（Internet eXchange Point）
   - 允许两个网络直接相连并交换分组
   - 时互联网上的数据流量分布更合理，同时减少分组转发的延迟

---

<br/>


<br/>


## 互联网的组成

### 边缘部分

由所有连接在互联网的主机（这些主机称为端系统 end system，可以是个人电脑，也可以是服务器，传感器）组成，这部分时用户直接使用的，用来进行通信和资源共享。

**端系统通信方式**

主机之间的通信其实是进程之间的通信

- 客户-服务器通信
   - 客户（client）和 服务器（server）都是通信中涉及的两个应用进程，值得注意的是客户不是使用计算机的人（user）而是计算机进程。客户是服务请求方，服务器是服务提供方。
   - 客户程序
      - 向服务器请求服务，需要知道服务器程序的地址
      - 不需要特殊的硬件和复杂的操作系统
   - 服务器程序
      - 可同时处理多个客户的请求
      - 被动接受客户服务请求，不需要知道客户程序地址（通信协议规定的，如果想要知道客户端地址，需要发送http请求）
      - 需要强大的硬件和高级的操作系统支持
- 对等连接方式
   - 简称P2P，是指两台主机在进行通信时，并不区分哪一个时服务请求方和服务提供方
   - 实际上对等连接方式仍然可以看作使用客户-服务器方式，只是对等连接中的每一台主机即使客户也是服务器
   - 只要双方主机都运行了对等连接软件（P2P软件），他们就可以进行平等的对等连接

---

<br/>


### 核心部分

在网络核心部分起作用的是路由器（router），是一种专用计算机（但不叫主机）。路由器是实现分组交换的关键构建，其任务是转发分组，这是网络核心部分的最重要功能。

**电路交换**

交换（switching）就是按照某种方式动态分配传输线路的资源。

建立连接（占用通信资源） $\Longrightarrow$ 通话（一直占用通信资源） $\Longrightarrow$ 释放连接（归还通信资源）

电路交换的一个重要特点就是在通话的全部时间内，童话的两个用户始终占用端到端的通信资源。

使用电路交换传送计算机数据时，其线路的传输效率往往很低，因为计算机的数据是突发式出现在传输线路上的。（早起电脑采用的拨号上网就是采用电路交换）

电路交换优缺点：
  - 通信时延小
  - 有序传输
  - 没有冲突
  - 适用范围广
  - 实时性强
  - 控制简单
  - 建立连接时间长
  - 独占线路，利用率低
  - 灵活性差
  - 难以规格化

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-26_11-11-13.png" width="500" />
</center>

<br/>

**分组交换**

   采用存储转发技术。把一个报文（message）划分为一个个更小的数据端，然后再每一个数据端前加上一些必要的控制信息组成的首部（header），构成一个分组（packet），又称为包，而首部也称为包头。
   
   主机和路由器都是计算机，但是作用不同。主机是为用户进行信息处理的，路由器则用来分组交换。
   
   分组时存储在路由器内存里面而不是磁盘，保证较高的交换速率。
   
分组交换优点：
- 高效：分组交换传输的过程中动态分配传输带宽，对通信链路逐段占用。
- 灵活：为每一个分组独立的选择最合适的转发路由
- 迅速：已分组作为传输单位，不先建立连接就能向其他主机发送分组
 - 可靠：保证可靠性的网络协议，分布式多路由的分组交换网，在网络有很好的生存性

 > - 动态带宽分配（DBA， Dynamically Bandwidth Assignment）是对PON的拥塞进行实时监控，OLT根据拥塞和当前带宽利用情况，以及配置情况进行动态的带宽调整。
> - 静态带宽分配，也可以称为固定带宽分配，指每个ONU占用的带宽是固定的，OLT会根据每个ONU的SLA（包括带宽、时延的指标）周期性的为每个ONU分配固定长度的授权。
 
分组交换的缺点：
- 有时延：分组再各个路由器存储转发需要排队，这会造成一定时间延迟
- 各个分组必须携带的控制信息也造成了一定的开销

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-26_14-32-23.png" width="600" />
</center>

<br/>


**报文交换**

**整个报文**先传送到相邻节点，全部存储下来后，转发到下一个节点

报文交换缺点：
- 转发时延
- 需要较大存储空间

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-26_14-36-40.png" width="600" />
</center>

---

<br/>


<br/>



## 计算机网络类别

### 计算机网络的定义

计算机网络的精确定义并未统一。

较好的定义：计算机网络主要是由一些通用的、可编程的硬件互连而成，而这些硬件并非专门用来实现某一特定目的，这些可编程的硬件能够用来传送多种不同类型的数据，并能支持广泛和日益增长的应用。


---

<br/>


### 相关分类

- 按照网络的作用范围
   - 广域网WAN（Wide Area Network）
   - 城域网 MAN（Metropolitan Are Network）：作用范围一般是一个城市
   - 局域网LAN（Local Are Network）
   - 个人区域网PAN（Personal Are Network）：在个人工作区域使用无线技术吧个人设备连接起来的网络，若中央处理器之间的距离很小，一般称为多处理机系统
- 按照网络使用者
   - 公用网（public network）
   - 专用网（privacy network）


接入网 AN（Access Network）称为本地接入网或居民接入网，本地 ISP 使用多种接入网技术把用户的端系统接入互联网，接入网实质上就是本地 ISP 拥有的网络，既不是互联网核心部分，也不是边缘部分。

---

<br/>


<br/>


## 计算机网络的性能

**速率**

- 单位是$bit/s$
- 当提到网络的速率时，指的是额定速率或标称速率，并非实际运行速率
- 应该特别注意单位转换，同时留意题目的要求

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-26_15-53-29.png" width="700" />
</center>

**带宽**
- 在计算机网络中，用带宽表示网络中某通道传送数据的能力，网络带宽表示在单位时间内网络中的某信道所能通过的“最高数据率”，单位和速率的单位相同
- 带宽越宽，所能传输的最高数据率就越高
- 带宽和速率的区别——将信道比喻为高速公路，传输速率：一条道路一定时间内能供多少车跑：带宽：严格来讲就是路有多宽。

**吞吐量**
- 表示在单位时间内通过某个网络的实际数据量
- 吞吐量受到网络的带宽和速率的限制


**时延**
 - 发送时延：主机或路由器发送数据帧所需要的时间。
- 传播时延：电磁波在信道中传播一定距离需要花费的时间。
- 处理时延：主机或路由器在收到分组时要花费一定时间进行处理，不方便计算，一般题目会说明忽略处理时延。
 - 排队时延：分组在进入路由器后要先在输入队列中排队处理，一般来说，排队时延和处理时延合成处理时延。

总时延=发送时延+传播时延+处理时延+排队时延，总时延要考虑四种时延，类似于木桶效应。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-26_16-26-18.png" width="600" />
</center>

<span style="background:#fff88f">由于路由器在处理分组时，可以将**上一个分组的存储和当前分组的转发工作同时进行**，所以有以下计算规律：</span>


<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-05_143157.jpg" width="700" />
</center>



**时延带宽积**

- 时延带宽积=传播时延$\times$带宽
- 若发送端连续发送数据，等第一个比特即将到达终点时，链路上有时延带宽积的个bit
- 又称以比特为单位的链路长度

> 发送缓冲区大小决定了发送窗口的上限，而发送窗口又决定了「已发送未确认」的飞行报文的上限。因此，发送缓冲区不能超过「带宽时延积」
> 发送缓冲区与带宽时延积的关系：
> - 如果发送缓冲区「超过」带宽时延积，超出的部分就没办法有效的网络传输，同时导致网络过载，容易丢包；
> - 如果发送缓冲区「小于」带宽时延积，就不能很好的发挥出网络的传输效率。

**往返时间RTT（Round-Trip Time）**
 - 很多情况下，互联网上的信息不仅仅当方向传输，而是双向交互
- 当使用卫星通信时，往返时间相对较长，是很重要的一个性能指标

**利用率**

- 分为信道利用率和网络利用率
    - 信道利用率：某信道又百分之几的时间是被利用的
    - 网络利用率：全网络的信道利用率的加权平均
- 根据排队论，当利用率提升时，该信道引起的时延也会增加，令$D_0$为网络空闲时的时延，$U$为利用率，则<span style="background:#fff88f">$D=\frac{D_0}{1-U}$</span>
- 当利用率达50%时，时延翻倍，当利用率超过50%时时延增加

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-26_17-02-38.png" width="300" />
</center>

**丢包率**
- 丢包率即丢失的分组数量和总分组数量的比例
- 网络用户通常意识不到网络丢包
- 丢包的情况
	- 分组出现误码，被节点丢弃
	- 分组到达一台队列已满的交换被丢弃，通信量较大时，可能会网络拥堵
		- 无拥堵时，路径丢包率为0
		- 轻度拥堵，路径丢包率为1%-4%
		- 严重拥堵，路径丢包率为5%-15%

---


<br/>


<br/>



## 计算机网络体系结构

### 相关术语

- 协议：为网络中的数据交换而建立的规则、标准或约定。网络协议主要有以下三个要素
   - 语法：数据与控制信息的结构或格式
   - 语义：即需要发出何种控制信息，完成何种动作以及做出何种相应
   - 同步：即事件实现顺序的详细说明，定义接收双方的时序关系

- 实体：任何可以发送或接受信息的硬件或软件进程
- 对等实体：接收方相同层次的实体，从这方面出发，协议是控制两个对等实体（或者多个实体）进行通信的规则集合

- 服务：在协议的控制下，两个对等实体的通信使得本层能够向上一层提供服务，要实现本层协议还需要使用下一层所提供的服务，使用本层服务的实体只能看见服务而无法看见下面的协议，协议对上面的实体是透明的，协议是水平的，而服务是垂直的，服务是由下层向上层的层间借口提供的，在一个层次的功能中只有能够被上一层看见的功能才是服务
- 服务访问点：在同一系统中相邻两层实体进行交互的地方
   - 数据链路层的访问结点为帧的“类型”字段
   - 网络层的服务访问点是IP数据报首部的“协议字段”
   - 运输层的服务访问点为“端口号”
- 服务原语：上层使用下层提供的服务必须通过与下层交换一些命令，这些命令成为服务原语
- 协议数据单元PDU（Protocol Data Unit）：对等层次之间传送的数据包
- 服务数据单元SDU（Service Data Unit）：同一系统中，层与层之间交换的数据包

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Screenshot_20220829_144919.jpg" width="700" />
</center>


---

<br/>


### 分层结构

OSI 七层协议体系结构概念清楚，理论较完整，但是复杂不实用。

TCP/IP 四层体系结构有广泛应用；

阐述计算机网络原理用五层协议体系结构。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-29_14-58-07.png" width="600" />
</center>


**原理体系结构**
- **应用层**（applicationg layer）：应用层的任务是通过**应用进程间的交互**完成特定网络应用，应用层协议定义的是应用进程间通信和交互规则，应用层交互的数据单元成为报文（message）
- **运输层/传输层**（transport layer）：向两台主机中**进程的通信**提供通用的数据传输服务，运输层主要采用以下协议
   - 传送控制协议TCP（Transmission Control Protocol）：提供面向连接的、可靠的数据传输服务，数据传输单元是报文段（segment）
   - 用户数据协议UDP（User Datagram Protocol）：提供无连接的，尽最大努力的数据传输服务，数据传输单元是用户数据报
- **网络层/网际层**：负责**交换网上不同主机**的提供通信服务
	- （1）通过一定算法在互联网上的每一个路由器生成一个用来转发分组的转发表
	- （2）每一个路由器在接收到一个分组时，依据转发表中指明的路径把分组转发到下一个路由器。在 TCP/IP 体系中，网络层使用 IP 协议，分组也成为 IP 数据报
- **数据链路层**：负责**分组在一个网络或一条链路上传输**的问题。数据链路层把网络层交下来的IP数据报组装成帧（frame），每一帧包括数据和必要的控制信息
- **物理层**：解决采用何种方式传输比特流的问题。物理传输介质并不属于物理层。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-29_15-22-02.png" width="600" />
</center>

**OSI 体系结构**
- **表示层**：通信双方交换信息的表示问题
- **会话层**：解决进程之间进行会话的问题
- 传输层：解决进程之间通过网络传输的问题

---

<br/>


<br/>


<br/>



# 物理层

## 基本概念

物理层规程：用于物理层的协议。在“协议”这个名词出现之前，人们就使用了“规程（procedure）”。

物理层的主要任务是确定与传输媒体的接口有关的一些特性：

- **机械**特性：指明接口所用接线器的的形状和尺寸、引脚数目和排列、固定和锁定装置
- **电气**特性：指明在接口电缆的各条线的上出现的电压范围
- **功能**特性：指明某条线上出现的某一电平的意义
- **过程**特性：指明对于不同功能的各种可能事件的出现顺序

---

<br/>


<br/>

## 数据通信基础

### 数据通信系统模型

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-06_100347.png" width="700" />
</center>

- 一个数据通信系统分为三大部分：（1）源系统（发送端）（2）传输系统（传输网络）（3）目的系统（接收端）
   - 源系统包括两部分：
      - 源点：源点设备产生要发送的数据
      - 发送器：源点生成的比特流要通过发送器编码后才能在传输系统中传输，典型的发送器就是调制器。
   - 目的系统包括两部分：
      - 接收器：接收传输系统传送过来的信号，并把它转换成能够被目的设备处理的信息。典型的接收器就是解调器。
      - 终点：把从接收器接收的信息输出。
- 通信的目的是传送消息（message）
- **数据（data）：运送消息的实体**
- **信号（signal）：数据的电气或电磁表示**
   - 模拟信号——用户家里的调制解调器到电话端局之间的用户线上传送的就是模拟信号
   - 数字信号——计算机到调制解调器之间或电话网中继线上传送的就是数字信号
      - 码元：使用时间域的波形表示数字信号是，代表不同离散数值的基本波形

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-50-43.png" width="700" />
</center>

---


<br/>


### 信道基本概念

- **信道（channel）和电路并不等同**，信道一般表示用来向某一个方向传送消息的媒体，一条通信电路往往包含一条发送信道和一条接收信道

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-52-29.png" width="400" />
使用信道复用技术，一条传输媒体有多条信道
</center>


- 通信双方交互的基本方式：
   - 单向通信（单工通信）：只能有一个方向的通信，只需一条信道——广播
   - 双向交替通信（半双工通信）：不能双方发送信息，至少需要两条信道——对讲机
   - 双向同时通信（全双工通信）：双方同时发送接收信息，至少需要两条信道

---

   - 串行传输：bit一个一个发送
   - 并行传输：一次发送多个bit，需要多条信道，计算机内部总线采用并行传输

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-48-23.png" width="350" />
</center>




---

   - 同步传输：数据块以稳定的比特流的形式传输，字节之间没有间隔 ，接收端再每个比特信号的中间时刻进行检测，不同设备时钟频率存在差异，再接收大量数据时会累计误差会使判别错位 ，需要保持双方时钟同步。
      - 外同步：再接收双方之间添加一条单独的时钟信号线
      - 内同步：发送端将时钟同步信号编码道发送数据中一起传输（以太网使用曼彻斯特编码）

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-46-27.png" width="700" />
</center>

   - 异步传输：**以字节为独立传输单位**，字节之间事件间隔不固定，接收端仅在每个字节的起始出对字节内的比特进行同步，要在每个字节前后加上起始位和结束位

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-46-48.png" width="700" />
</center>

---

- 基带信号：来自信源的信号，往往包含较多低频分量，甚至直频分量，需要调制（modulation）才能在信道传输。调制可分为两种：
   - 基带调制：仅仅对基带信号的波形进行变换，变换后的信号仍然是基带信号（把一类数字信号转换成另一类数字信号），该过程也被称为编码（coding），常用编码方式：
	   - 归零制 **RZ**：正脉冲代表 1，符脉冲代表 0
      - 不归零制 **NRZ**：正电平代表 1，负电平代表 0
      - 反向不归零 **NRZI**
      - 曼彻斯特编码：周期中心向上条代表 0，向下跳代表 1，**也可以反过来定义**。将数据和时钟包含在信号中，**跳变作为时钟和数据信号**。
      - 差分曼彻斯特编码：位边界开始用<span style="background:#fff88f">**跳动代表 0，没有跳动代表 1**</span>，**跳变仅作为时钟信号**。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-54-46.png" width="550" />
</center>

   - 带通调制：把基带信号的频率范围搬移至较高频率，并转换位模拟信号，使用载波（carrier）进行调制，基本的带通调制方式：
      - 调幅（AM）：载波的振幅随基带信号而变化
      - 调频（FM）：载波的频率随基带信号而变化
      - 调相（PM）：初始相位随基带信号而变化
      - 以上调制位单元调制，为达到更高的传输效率，可以采用多元制调制，方式结合起来使用，例如正交振幅调制，为了降低错误率，码元对应的比特之间的对应关系应该为**格雷码**

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-06_101351.jpg" width="400" />
</center>

---

<br/>


### 信道极限容量

码元的传输速率越高、信号传输距离越远、噪声干扰越大或传输媒体质量越差，在接收端的波形失真就越严重。

- **带宽**：在模拟信号系统中，信道能够通过的频率范围；在计算机网络中，通信线路的最大数据传输率。以下两种计算公式都是使用模拟信号系统中带宽的定义，单位为 Hz。
- **码间串扰**：信号中的高频分量在传输时受到衰减，信号波形失去码元之间清晰界限
- **奈氏准则**：在带宽为$W$（Hz）的低通信道中，若不考虑噪声影响，**<span style="background:#fff88f">码元传输的最高速率是$2W$（Baud波特，即码元/秒）</span>**，传输速率超过此上限，会出现严重的码间串扰
- **信噪比**：信号的平均功率和噪声的平均功率之比，记为 $S/N$ 。通常用分贝（dB）作为单位，则

$$\text{信噪比}\left( dB \right) =10\log _{10}\left( \frac{S}{N} \right) \left( dB \right)$$

   - **香农公式**：指出有带宽限制以及高斯白噪声影响的信道极限传输速率$C$

$$C=W\ \log _2\left( 1+\frac{S}{N} \right) \left( bit/s \right)$$

---

<br/>


<br/>



## 传输介质

传输介质也成为传输媒体，可分为两大类：

- **导引型传输媒体**
   - 双绞线：把两根相互绝缘的铜导线并排放在一起，然后按照一定规则绞合起来，**绞合可减少对相邻导线的电磁干扰**。几乎所有的电话都采用双绞线连接到电话交换机，**传统以太网基本也是采用各种类型的双绞电缆进行连接**。
      - 无屏蔽双绞线 UTP（Unshielded Twisted Pair）
      - 屏蔽双绞线 STP（Shielded Twisted Pair）
         - 如果是给整条电缆进行屏蔽，x/UTP表示用某种材料对整条双绞电缆进行屏蔽（内部双绞线没有进行屏蔽），x不同，包裹材料不同
            - x 为 F，铝箔屏蔽层
            - x 为 S，金属编织屏蔽层，弹性较好，易于弯曲
            - x 为 SF，表示在铝箔屏蔽层外面再加上金属编织屏蔽层
         - 如果是对内部每一个双绞线进行屏蔽
            - U/FTP，外部不再另设屏蔽层
            - F/FTP，整条电缆再加上铝箔屏蔽层
            - S/FTP，整条电缆再加上金属编织屏蔽层
   - 同轴电缆：具有很好的抗干扰能力，被广泛用于传输较高速率的数据
   - 光纤
      - **多模光纤**：多个不同入射角的的光线再一条光纤中传播。光脉冲再多模光纤中传输会逐渐展宽，**只适合用于近距离传输**。
      - 单模光纤：光纤直径缩小道一个光的波长。成本较高，单衰耗较小。
      - 光纤通信常用的3个波段中心分别位于850nm，1300nm，1550nm。
      - 光纤通信优点：
         - 通信容量大
         - 传输损耗小，中继距离长
         - 抗雷电和电磁干扰性能好
         - 无串音干扰，保密性能好
         - 体积小，重量轻
- **非导引型传输媒体**

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-20-07.png" width="700" />
</center>

无线电波

靠地面反射，或电离层发射。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-21-09.png" width="700" />
</center>

微波

会穿透电离层，进入宇宙，所以需要中继站。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-26-27.png" width="700" />
</center>

红外线
- 点对点无线传输
- 直线传输，中间不能有障碍物体
- 传输速率低

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-08-30_14-27-51.png" width="400" />
</center>



----

<br/>


<br/>


<br/>



# 数据链路层

数据链路层属于计算机网络的低层，负责通过一条数据链路从一个节点向另一个物理链路直接相连的节点传输数据，主要采用**点对点信道**和**广播信道**。研究在同一个局域网中，分组怎么从一台主机传给另一台主机。


- 链路与数据链路
   - 链路：从一个节点到另一个相邻节点的物理线路，只是一条路径的组成部分。
   - **数据链路：不仅包括物理链路，还包括控制数据传输的协议**。最常用网络适配器来实现这些协议。
- 帧：数据链路层把从网络层交下来的数据包装成帧发送到链路上面，以及把接受到的帧中的数据取出并上交给网络层。

## 数据链路层功能概述

数据链路层在物理层提供服务的基础上向网络层提供服务，其主要作用是加强物理层传输原始比特流的功能，将物理层提供的可能出错的物理连接改造成逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路。

- 向网络层提供服务
   - 无确认无连接服务：不需要事先建立连接，对丢失帧，数据链路不负责重发，而是交给上层处理。适用于实时通信或误码率较低的通信信道，如以太网。
   - 有确认的无连接服务：不需要事先建立连接，目的机器收到数据帧必须发回确认，源机器在所规定的时间内为收到确定信号，就重传丢失的帧。适用于误码率较高的通信信道，如无线通信。
   - 有确认有连接服务
- 链路管理：即数据链路的建立、维持和释放的过程。主要用于面向连接的服务。
- **封装成帧**
- **流量控制**：控制发送方的的数据流量，时期发送速率不超过接收方接收能力。并不是数据链路层特有的功能，对于数据链路层控制的是相邻两节点之间的流量。
- **差错控制**


---

<br/>


<br/>


## 封装成帧

封装成帧就是在一段数据的前后分别添加首部和尾部，构成一个帧。一个帧的长度等于数据部分长度加上帧首部和尾部的标记。
- 帧的首部和尾部包含很多控制信息，进行帧定界。
- 为了提高发送效率，应该使帧的数据部分尽可能大于首部和尾部的长度。数据部分的长度上限——**最大传送单元MTU**（Maximum Transfer Unit）

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-08-09-15-27.jpg" width="700" />
</center>

- 当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符——SOH（Start Of Header）00000001、EOH（End Of Header）00000100。两个帧定界符分别位于帧的第一个字节和最后一个字节。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-08-09-20-04.jpg" width="700" />
</center>


<br/>

**透明传输**

**对上层交付的数据不能有任何的限制**，不管所传数据是什么样的比特组合，都应当能够在链路上传送，当所传数据中的比特组合恰巧与某一个控制信息完全一样时，就必须采取适当的措施，使接收方不会将这样的数据误认为是某种控制信息。 


- **字符填充法**：用于面向字节传输的物理链路。用特定字符（帧定界符）来定界。当数据部分含有定界符时，需要在其前面加上一个特定的转义字符字符，而当数据部分含有转义字符，同样在其前面加上一个转义字符。
	- 发送端的数据链路在数据中出现“SOH”或“EOH”的前面插入转义字符“ESC”，如果出现“ESC”那就在其前面再加一个“ESC”
	- 接收端在向网络层传输数据之前应删除之前插入的转义字符。这种方法就是字节填充（buffer stuffing）或字符填充。
- **零比特填充法**：用于面向比特流的物理链路。允许数据帧包含任意个数的比特。用一个特定的比特模式来界定帧的边界（01111110）（含有连续的 6 个 1）。当数据部分出现连续的 5 个 1 时，就在后面插入一个 0，这样保证了数据部分不会出现用于定界的比特模式。进行接收时，先界定帧的边界，然后扫描帧的内容，当发现连续 5 个 1，去掉后面一个 0，即可复原。（容易用硬件实现，性能由于字节填充法）。

<br/>


**组帧方法**

- 字符计数法：在帧头部使用一个计数字段来表明帧内字符数。目的加点的数据链路层收到字节计数值时就知道后面跟随的字节数。如果计数字段出现错误，接收双方将失去同步。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-09-09-34-26.jpg" width="700" />
</center>

- 字符填充法
- 零比特填充法
- 违规编码法：在物理层进行比特编码时通常采用违规编码法。例如在曼彻斯特编码中，使用“高-低”电平表示“1”，“低-高”电平表示“0”,而“高-高”电平和“低-低”电平是违规的。因此可以采用“高-高”，“低-低”分别表示帧的起始和终止。局域网IEEE802采用此方法。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-11_09-16-29.png" width="500" />
</center>

---

<br/>


<br/>


## 差错控制

传输中的错误可以分为**比特错误** 和 **帧错误**。对于比特错误通常采用编码技术进行差错控制。
- 自动重传机制（ARQ）：接收端检测到错误，通知发送端重发，直到收到正确的码字，需要检错码实现。
- 前向纠错（FEC）：接收端不仅能发现错误，而且能纠正错误。需要纠错码实现。

对于帧错误：有帧丢失、帧重复、帧失序
- 没有比特错误并不等于没有传输差错。还可能出现帧丢失、帧重复、帧失序
- 在CRC基础上增加了帧编号，确认和重传机制
   - 对于通信质量良好的有线传输链路，数据链路层协议不使用确认和重传机制，不要求数据链路向上提供可靠传输。若出现问题，更改错误由上层协议完成。
   - 对于通信质量较差的无线传输，则要求使用确认和重传机制。

### 检错编码

检错编码都是采用冗余编码技术，其核心思想是在有效数据为被发送前，添加一定的冗余位。

- 奇偶检验码：奇校验码和偶校验码的统称。附加一个校验元，使编码中“1”的个数为奇数或偶数。只能检验出奇数个错误。检错能力为50%。
- 循环冗余码
   - 比特在传输过程中可能发生错误，导致“0”和“1”颠倒。误码率 BER（Bit Error Rate）——错误比特占总比特的比值。
   - 数据链路层广泛采用循环冗余检验CRC（Cyclic Redundancy Check）
   - 接收端在接收时会使用约定的生成多项式进行检验，若得到余数为 0 则接收，不为 0 就丢弃

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-08-10-10-41.jpg" width="700" />
</center>

---

<br/>




### 纠错编码

海明码：
- 确定海明码的位数： $n$ 为信息位, $k$ 为校验位的位数，则满足 $n+k+1\le 2^k$
 - 检验位的分布：校验位$P_1$分布在$2^{i-1}$位，其余非一次放入信息位
- 校验码校验的信息位：每个校验位的序号的二进制表示，必然只包含一个1，校验位负责校验信息位序号对应位为1的所有信息位，如图所示：

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-07-31_142617.png" width="500" />
</center>


- 校验位的取值：校验位和对应要校验的数据位进行异或运算，使得结果为 0（即出现偶数个1）
- 海明码校验原理：接收方收到数据后，一次对各个检验位和对应要校验的数据位进行异或运算

$$S1=P1\oplus D1\oplus D2\oplus D4$$
$$S2=P2\oplus D1\oplus D3\oplus D4$$
$$S3=P3\oplus D2\oplus D3\oplus D4$$

若 $S3,S2,S1$ 为000，表示无错，否则该序列表示出错位的位置。

----

<br/>


<br/>



## 流量控制和可靠传输机制

- **流量控制**：基本方法是由接收方控制发送方发送数据的速率，常见的方式有两种：停止-等待协议、滑动窗口协议。
- **可靠传输**：通常使用确认和超时重传机制来完成。确认是一种无数据的控制帧，用于确认那些内容被接收方正确接收。有时提高传输效率，将确认捎带在一个回复帧里面，称为**捎带确认**。超时重传是指发送方在发送某个数据帧后就开启一个计时器，在一定时间内没有收到确认帧，就重发数据帧，直到发送成功。
   - **自动重传请求ARQ**（Automatic Repeat reQuest）：通过接收方请求发送方重传出错的数据帧来回复数据帧。传统的ARQ分为三种：停止-等待协议（Stop-and -Wait）、后退N帧协议（Go-Back-N）、选择性重传协议（Selective Repeat）。后面两种协议是滑动窗口技术和请求重发技术的结合。

现有的实际有线网络的数据链路很少采用可靠传输（不同于 OSI 参考模型的思路），很多教材把这部分放到运输层讨论，与 408 考纲不同，但是这里学习的可靠传输的思想可以运用到运输层。


### 停止-等待协议

源站发送单个帧后必须等待确认。在目的站的回答来到之前，源站不能发送其他的数据帧。从滑动窗口机制来看，相当于**发送窗口和接收窗口都等于 1** 的滑动窗口协议。

#### 出现差错的情况

   1. 接收端检测帧出错或帧丢失：发送完一个帧后就启用超时重传计时器，计时器结束都没有收到确认帧，就进行重传。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_08-59-22.png" width="600" />
</center>

   2. 确认帧丢失：接收方会收到相同的帧，此时接收方丢弃重复的帧，并重新进行确认。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_09-02-53.png" width="600" />
</center>

   3. 确认帧迟到：接收方会收到重复的确认帧，收下便进行丢弃。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_09-05-07.png" width="600" />
</center>



有以上三种情况可知，为解决出错的情况：

- 必须对**发送帧和接收帧进行编号**，由于发送窗口和接收窗口都只有一个，用一个 bit 编号即可：发送帧用 0 和1  标识，确认帧用 ACK0 和 ACK1 进行标识。
- 为了超时重传和确认重复帧的需要，发送方和接收方都要设置一个帧缓冲区，发送发在发送完帧后在缓冲区保存其副本，在收到确认帧后才可以进行删除。


#### 性能分析

信道利用率：在一个发送周期内，发送时延占整个发送周期的比例。

信道吞吐率：信道利用率 $\times$ 发送速率

停止等待协议简单但信道利用率低。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_09-20-01.png" width="700" />
</center>

---

<br/>


### 后退 N 帧协议 GBN（Go-Back-N）

GBN 协议中**发送方窗口>1，接收方窗口数=1**，采用 n 比特进行编号，则<span style="background:#fff88f">发送方窗口尺寸 $1\le W_T \le 2^n-1$ </span>，如果超过上限，接收方将无法区分新帧和旧帧。**发送方无需收到上一个帧的 ACK 就可以发送下一个帧**。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_09-52-20.png" width="700" />
</center>



#### GBN发送方的行为

- 响应上层的调用：当上层要发送数据时，发送方先检查窗口是否已满。未满，则封装成帧放入发送窗口，已满，则先缓存等窗口空闲再进行发送。（或将数据返回给上层，表示窗口已满）
- **累计确认**：发送方收到一个 ACK，则说明 n 号帧以及之前的所有帧都发送成功，发送方可以对他们进行成功确认。
- 超时时间：如果超时计时器超时，发送方仍然没有收到对应ACK，发送方会重新发送所有已经发送但是没有被确认的帧。

#### 接收方的行为

- 如正确收到 n 号帧，返回对应 ACK，并将数据交付给上层。（由于信道采用全双工通信，接收方可以是发送方，所以采用捎带确认）
- 其余情况都丢弃帧，并返回最后一个收到的 n 号帧的 ACK，接收方无需缓存失序的帧，只需要维护一个信息：expectedseqnum（下个期待接收到的帧的序号）

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_10-10-04.png" width="700" />
</center>

#### 性能分析

- 连续发送数据帧提高了信道的利用率。
- 另一方面在进行重传时有把原来已经正确传送的数据帧进行重传，**在通信质量差的信道中，传输效率低**。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-13-10-15-27.jpg" width="700" />
</center>


---

<br/>

### 选择重传协议 SR（Selective Repeat）

为解决 GBN 批量重传的缺点，可以设置**单个确认**，加大接收窗口，缓存乱序的帧，这就是 SR 的原理。SR 协议中发送方窗口和接收方窗口都 >1，最好两者相等（发>收，则溢出，发<收，则浪费），采用 n 比特进行编号，则<span style="background:#fff88f">**发送方窗口尺寸 $1\le W_T \le 2^{n-1}$ **</span>。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_10-52-50.png" width="600" />
</center>

#### SR发送方的响应

- 上层的调用：跟 GBN 一致，先检查窗口长度，有空余就发送，无空余要么缓存要么返回给上层。
- 接收 ACK：收到 ACK 后，将 ACK 确认的帧标记为已确认。**如果该帧是窗口的下界，就将窗口移动到最后一个已发送但未确认的帧或未发送端帧处**，此时如果窗口内有为发送的帧就进行发送。
- 超时时间：每个帧都有计时器，超时即重传对应的一个帧。


#### 接收方的响应

- 若接收到一个窗口内的帧，就缓存，并返回一个确认帧，直到所有帧被收到（之前的帧），然后窗口向前滑动。
- 如果收到小于窗口下界的帧，就返回一个ACK。其余情况皆忽略。

---

<br/>

### 滑动窗口长度

在 GBN 和 SR 协议中都有滑动窗口长度的限制。长度的限制本质上是为了避免冲突，在极端的情况区分新帧和旧帧，总之，**发送方和接收方窗口长度之和 不能超过帧序号的个数 $2^n$** 。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-13-11-18-46.jpg" width="600" />
极端情况
</center>

---

<br/>


<br/>


## 介质访问控制

传输数据采用两种链路：

- **点对点链路**：两个相邻节点通过一个链路连接，没有第三者，常用于广域网。
- **广播式链路**：所有主机共享通信介质，局域网。

介质访问控制为 使用使用介质的每个几点隔离来自同一信道的其他节点所传送的信号，以协调活动节点的传输。用来决定广播信道中信号分配的协议**属于数据链路层的**一个子层，称为**介质访问控制（Medium Access Control，MAC）子层**。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-44-28.png" width="700" />
</center>

常见的介质访问控制方法有：信道划分介质控制（静态）、随机访问介质访问控制和轮询访问介质控制（动态）。


### 信道划分介质访问控制

当传输介质的带宽超过传输单个信号所需的带宽时，人们就通过多路复用来提高传输系统利用率。

多路复用技术：把多个信号组合在一条物理信道进行传输。

#### 频分多路复用 FDM（Frequency-division multiplexing）

FDM 是将多路基带信号**调制到不同频率载波上**，在**叠加成一个复合信号**的多路复用技术。在物理信道的可用带宽超过单个原始信号的带宽的情况下，可将该物理信道的总带宽划分成若干与传输单个信号带宽相同（或略宽）的子信道，每个子信道传输一种信号。为防止子信道之间的干扰，相邻信道之间需要加入“**保护频带**”。

容易实现，技术成熟。信道复用率高，分路方便，因此频分多路复用**是模拟通信中常采用的一种复用方式**，特别是在**有线和微波通信**系统中应用十分广泛。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_13-51-28.png" width="700" />
</center>


#### 时分多路复用 TDM（Time-division multiplexing）

TDM 将一条物理信道**按照时间分成若干时间片**，**轮流分配**给多个信号使用。由于计算机数据的突发性，一个用于对已经分配到的子信道的利用率不高。**统计时分多路复用 STDM**（statistical time division multiplexing）（也称异步时分多路复用）是 TDM 的改进，按需要动态分配时间间隙。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-13_13-58-24.png" width="700" />
</center>

#### 波分多路复用 WDM（wavelength-division multiplexing）

WDM 是光的频分多路复用，一根光纤中传输多种不同波长的光信号，由于波长不同，各路光信号互不干扰。


#### 码分多路复用 CDM（code division multiplexing）

更常用的名词是**码分多址 CDMA（Code Division Multiple Access）**，每个比特时间划分为 m（通常是64或128）个时间槽，称为**码片（chip）**。**每个站点被指定一个唯一的 m 为码片序列**，发送规则如下：

- 单个站点的发送
   - 当站点要发送 1 时，发送自身码片序列
   - 当站点发送 0 时，发送码片序列的反码
- 不同站点的码片序列的内积为 0
   - 如，$S\cdot T=\frac{1}{m}\sum_{i=1}^m{S_iT_i=0}$
- 多个站点同时发送
   - 各路信号在信道中线性相加。
- 信号的分离
   - 对叠加信号和站点的码片序列进行内积运算，得到对应站点发送的数据。
   - 原理是，不同站点的码片序列是正交的，对叠加信号进行和码片序列算内积时，其他站点的信号会被滤掉。

CDMA 技术具有频谱利用率高、抗干扰能力强、保密性强、语音质量好的优点，还可以减少投资和降低运行成本，主要用于**无线通信系统，特别是移动通信系统**。



---

<br/>


### 随机访问介质访问控制

在随机访问协议中，不采用集中控制方式解决发送信息的次序问题，所有用户能够根据自己的意愿随机发送信息，占用信道全部速率。子总线型网络中，当多个用户同时发送信息时，就会发生真的冲突（碰撞），导致所有的冲突用户的发送均以失败告终。为解决冲突，每个用户需要按照一定规律重传帧，直到该帧无碰撞通过。随机访问控制协议的核心思想是：胜利者通过争用获得信道，从而获得信息的发送权。


#### ALOHA协议

**纯 ALOHA 协议**

- 纯 ALOHA 协议的核心思想是：当用户需要发送数据时，**不需要进行检测直接发送**，如果在**一段时间内未收到确认，该站点就认为传输中发生了冲突。并以以概率 p 重传该帧**。**否则，该节点等待一个帧传输时间**。在此等待后，它则以概率 p 传输该帧，或者以概率1-p 在另一个帧时间等待（保持空闲），以此类推。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-14_18-31-24.png" width="700" />
</center>

- 效率分析：假设有 $N$ 个节点，一个帧在 $t_0$ 开始传输，则在 $t_0-1$ 到 $t_0$ 时间内不能有节点开始传输，概率为 $(1-p)^{N-1}$ ，同理 $t_0$ 到 $t_0+1$ 时段内也不能有帧开始传输，可以得到**该帧传输成功的概率 $p(1-p)^{2(N-1)}$** ，当 $N$ 趋于无穷时，求极限得到 $\frac{1}{2e}\approx 0.184$ 。可以看出纯 ALOHA 网络的吞吐量很低，在此基础上改进得到了时隙 ALOHA 协议。


**时隙 ALOHA 协议**

- 时隙 ALOHA 协议把所有站点在**时间上同步起来，并时间划分为一段段等长的时隙（Slot）**，规定**只能在每个时隙开始时才能发送一个帧**。避免用户发送数据的随意性，减少冲突产生的可能性。时隙 ALOHA 协议和纯 ALOHA 在处理冲突的手段类似——发生了冲突时，以概率 p 重传该帧，或者以概率 1-p  在另一个帧时间等待（保持空闲），当下一个时隙到来时，也是以此类推。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-14_18-53-45.png" width="700" />
</center>

- 效率分析：推导与纯 ALOHA 类似，一个帧发送成功的概率为 $p(1-p)^{N-1}$ ，当 $N$ 趋于无穷时，求极限得到 $\frac{1}{e}\approx 0.368$ ，刚好**是纯 ALOHA 协议的两倍**。


#### CSMA 协议

载波侦听多路访问协议 CSMA（Carrier Sense Mutiple Access）是在 ALOHA 基础上提出的一种改进协议，增加了载波侦听装置，**站点在发送数据之前先侦听一下通用信道，发现信道空闲后再发送**，降低了碰撞发生的可能性。

根据侦听方式和侦听到信道忙后的处理方式不同，CSMA 分一下 3 种：

- **1-坚持 CSMA**：发送数据时，先侦听信道，信道空闲便直接发送；信道忙，等待同时坚持听直到信道空闲；如果发生冲突，随机等待一段时间后，再开始监听信道。
- **非坚持 CSMA**：发送数据时，先侦听信道，信道空闲便直接发送；信道忙，放弃侦听，等待一个**随机**的时间后再重复以上过程。
- **p-坚持 CSMA**：p-坚持 CSMA 用于**时隙信道**。基本思想：一个结点要发送数据时，首先侦听信道；如果信道忙，**下一个时隙再进行监听**，直至信道空闲；如果信道空闲，以 p 概率发送数据，或者以（1-p）概率等到下一个时隙在依据情况进行决定（类似 ALOHA 协议）。


#### CSMA/CD 协议

具有碰撞检测的载波侦听多路访问CSMA/CD（CSMA with Collision Detection）是CSMA的改进，使用总线形网络或半双工网络环境。**“碰撞检测”就是便发送边侦听，即适配器边发送边检测信道上的信号电压变化（发送数据的同时，不会收到数据，否则说明碰撞）**，以便于判断自己在发送数据时其他站点是否也在发送数据。
CSMA/CD工作流程：

   1. 适配器从网络层获得一个分组，分装成以太网帧，放入适配器的缓存，准备发送。
   2. 适配器侦听到信道空闲，就开始发送；若检查到信道忙，就持续侦听直到信道上没有信号能量，然后开始发送。
   3. 在发送过程中，适配器**持续检测信道**。若一直未检测到碰撞，传输完毕；若检测到碰撞，中止数据发送，并发送一个拥堵信号，让所用用户都知道。
   4. 中止发送后，执行指数退避算法，等待一个时间后在回到第二步。

传播时延对侦听的影响：
由于数据在总线上传输是有时延的，从下图可以看出在发送帧后**经过 $2\tau$ 如果没检测到碰撞，就知道发送成功。 $2\tau$ 也叫争用期**。


<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_09-15-31.png" width="700" />
</center>

**如果帧的长度过短，那么在检测到碰撞之前，帧就可能发送完成了**，为了避免这种情况，必须确定一个**最小帧长**， $\text{最小帧长}=2\tau \times \text{数据传输速率}$


**指数退避算法**

   1. 确定基本退避时间，一般取 $2\tau$
   2. 定义参数 k，在不超过 10 的时候，等于重传次数
   3. 从集合 $\{0\text{，1,...,}2^k-1\}$ 中随机选取一个数 r，重传需要的退避时间 $t=r \times 2\tau$
   4. 当重传次数达 **16** 次时，说明网络太拥挤，保持此帧，并向上层报告出错。


#### CSMA/CA 协议

载波侦听多路访问/碰撞避免（CSMA with collision avoidance）是运用在**无线局域网**环境的协议。

无限局域网**不能进行碰撞检测 CD** 的原因

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_161308.jpg" width="600" />
</center>

<br/>


**802.11 无线局域网**使用 CSMA/CA

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_161539.jpg" width="600" />
</center>

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_161810.jpg" width="600" />
</center>

<br/>


**退避算法**

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_162031.jpg" width="700" />
</center>

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_162305.jpg" width="660" />
</center>

<br/>


**信道预约与虚拟载波监听**

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_162516.jpg" width="700" />
</center>

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_162635.jpg" width="700" />
</center>


<br/>

CSMA/CD 和 CSMA/CA 对比

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-07-03.png" width="700" />
</center>


---

<br/>


### 轮询访问介质访问控制

轮询协议

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-20-27.png" width="700" />
</center>

令牌协议

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-21-27.png" width="700" />
</center>


---

<br/>


<br/>


## 局域网

### 基本概念 

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-46-39.png" width="700" />
</center>

**网络拓扑**

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-49-28.png" width="600" />
</center>


其中，总线型拓扑应用范围广。

传输介质

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-50-46.png" width="700" />
</center>



介质访问控制方法

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-52-01.png" width="700" />
</center>

**LAN分类**

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_10-53-40.png" width="700" />
</center>

**IEEE 802标准**

- IEEE802.3——以太网
- IEEE802.5——令牌环网
- IEEE802.8——FDDI
- IEEE802.11——WLAN

---

<br/>


### IEEE802.3 以太网

IEEE822.3 标准是一种基带总线形的局域网标准。严格来说以太网应当是指符合 **DIX EthernetV2** 标准的局域网，但 DIX EthernetV2 标准与 IEEE802.3 标准差距很小，因此通常成 IEEE822.3 标准局域网为以太网。

以太网**逻辑上采用总线形拓扑结构**，信息以广播的形式发送，为了保证数据通行的方便和可靠，以太网简化了通信流程并使用 **CSMA\CD** 方式对总线进行控制。

以太网简化通信措施：

   1. 采用无连接的工作方式，提供**不可靠服务**
   2. 发送的数据都使用**曼彻斯特编码**的信号


#### 传输介质和网卡

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-15-14-54-46.jpg" width="720" />
</center>

10BASE-T拓扑结构为星形，当逻辑结构依然是总线型
- 网络接口板：计算机和外界局域网的连接是通过**网络接口板（网络适配器Adapter、网络接口卡NIC，Network Interface Card）**实现的，可以将计算机内部传输的并行信号和以太网传输的串行信号进行转换。
- 介质访问控制（MAC）地址：网卡在出厂是唯一的代码，数据链路层设备（网桥、交换机）使用 MAC 地址。又称为物理地址，长度为 **6字节**，一般用连字符或冒号分隔的 12 个十六进制数表示。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_165237.jpg" width="700" />
</center>


#### MAC 帧

总线上使用的是广播通信，网卡在收到一个 MAC 帧时，首先要用硬件检查 MAC 帧的 MAC 地址，不是发给自己的帧则丢弃。

MAC 帧有两种标准：即 DIX EthernetV2 标准与 IEEE822.3标准

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-15-15-12-26.jpg" width="700" />
</center>

- 前导码：有 7 字节同步码，用于快速实现 MAC 帧的比特同步，还有帧开始定界符，标记后面就是 MAC 帧，MAC 帧不需要帧结束定界符，因为以太网在传送帧时，各帧之间一定有间隙，但这并不意味着 MAC 帧没有尾部（有 FCS）。
- DIX EthernetV2 标准与 IEEE802.3 标准帧的不同在于，**IEEE802.3 标准帧用长度域代替类型域**，**在实践中，这两种帧可以并存**，因为数据段的最大长度为1500，因此从 1501 到 65535 的值可用于类型段标识符。


#### 高速以太网

速率**达到或者超过100Mb/s**的以太网称为高速以太网 

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_15-35-49.png" width="700" />
</center>



> 集线器和交换机区别
> 
> 交换机工作在数据链路层，通过 MAC 地址转发数据。集线器工作在物理层，通过广播的形式转发数据。目前，集线器已经被交换机取代，组网中很少使用集线器。
> - 工作层次：集线器工作在物理层，属于1层设备，每发送一个数据，所有的端口均可以收到，采用了广播的方式，因此网络性能受到很大的限制。交换机工作在数据链路层，属于2层设备，通过学习之后，每个端口形成一张MAC地址转发表，根据数据包的MAC地址转发数据，而不是广播形式。
> - 转发方式：**集线器的工作原理是广播形式**，无论哪个端口收到数据之后，都要广播到所有的端口，当接入设备比较多时，网络性能会受到很大的影响。**交换机根据MAC地址转发数据**，收到数据包之后，检查报文的目的MAC地址，找到对应的端口进行转发，而不是广播到所有的端口。
> - 传输模式：集线器内部采用了总线型拓扑，各个节点共用一条总线进行通信，数据包的发送和接收采用了CSMA/CD协议，在同一时间内必须是单向的，只能维持在半双工模式下。两个端口不能同时收发数据，并且当两个端口通信时，其他端口不同工作。
> 
> **都扩大广播域，但是交换机隔绝了冲突域。**

---

<br/>


### IEEE802.11无线局域网

#### 无线局域网的组成

**有固定设施的无线局域网**

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_16-39-21.png" width="700" />
</center>



IEEE802.11使用星型拓扑，其**中心为接入点 AP**（Access Point），在 MAC 层使用 CSMA/CA 协议**。使用802.11系列协议的局域网又称为 Wi-Fi**。

WLAN 的最小构件是基本服务集 BSS（Basic  Service Set）。一个 BSS 包括一个 AP 和若干移动站。一个 BSS 覆盖的地理范围称为一个基本服务器 BSA（Basic Service Area），BSA 的直径一般不超过100m。

一个 BSS 可以是孤立的，也可以通过 AP 连接到一个拓展服务集 ESS。

<br/>

**无固定基础设施移动字组织网络**

没有 AP，各节点之间的地位平等，中间都是转发节点

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-15-16-56-23.jpg" width="650" />
</center>



#### IEEE802.11的 MAC 帧

只需了解帧头部格式即可

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-15_16-59-46.png" width="700" />
</center>


---

<br/>

### VLAN

一个以太网是广播域，当一个以太网包含计算机太多，会导致一下结果：

   1. 出现大量广播帧，特别是 ARP 和 DHCP 协议
   2. 不同单位共用一个局域网，不利于信息保密

通过虚拟局域网，可以把一个较大的局域网划分为一些较小的与地理位置无关的逻辑上的 VLAN。

VLAN 的以太网帧的拓展格式，**在以太网帧中插入一个4字节的标识符，称为 VLAN 标签**，用于指明发送该帧的计算机**属于哪个虚拟局域网**。插入 VLAN 标签后，以太网帧变成 **802.1Q 帧**。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-15-17-07-56.jpg" width="700" />
</center>

VLAN 标签前两个字节置为 0x8100，后两个字节中，前 4 位没有用，后 12 位 为 VID。插入 VLAN 标签后，FCS 必须重新计算。


---

<br/>


<br/>


## 广域网

### 基本概念

广域网是指覆盖很广的长距离网络，是因特网的核心部分，其任务是长距离运输数据，将局域网连接起来。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-15-17-40-41.jpg" width="650" />
</center>

广域网由一些结点交换机和连接这些结点的链路组成。

局域网和广域网的区别

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-15-17-43-25.jpg" width="700" />
</center>


---

<br/>


### 点对点协议 PPP

PPP（Point-to-Point Protocol）协议是为**点对点传输 多协议数据包**提供了一种方法。PPP 协议包含一系列协议。提供全双工操作，并按照顺序传递数据包。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-08_21-11-46.png" width="600" />
</center>

#### PPP 协议特点

PPP协议满足的要求

- 简单：IETF（互联网工程任务组）把互联网体系结构中最复杂的部分放在 TCP 协议中，TCP 以下的协议没有必要提供更复杂的功能。不需要纠错（只需要执行 CRC 检验），不需要序号，不需要流量控制。
- 封装成帧
- 透明性：不管所传数据是什么样的比特组合，都应当能够在链路上传送。
- 多种网络层协议：在同一条物理链路上同时支持多种网络层协议的运行。
- 多种类型链路
- 差错检验
- 检测连接状态
- 最大传送单元
- 网络层地址协商
- 数据压缩协商


#### PPP协议的组成

- 将IP数据包封装到串行链路的方法：既支持异步链路，也支持同步链路。
- **链路控制协议 LCP**（Link Control Protocol）：建立、配置和测试数据链路连接的协议。
- 一套网络控制协议NCP（Network Control Protocol）：其中每一种协议支持不同网络层协议。

#### PPP 协议的帧格式

字段含义

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-08-18-49-10.jpg" width="700" />
</center>

- 开头第一个和尾部最后一个字段是标志字段 F（Flag）, 规定为0x7E（01111110）。
- 地址字段规定为0xFF，控制字段C规定为0x03。这两个字段至今没有定义。
- **协议字段**说明了帧封装的是什么协议的数据。
- 信息字段的长度可变，不超过1500字节。

**字节填充**

当 PPP 使用 异步传输时，**转义字符定义为 0x7D**，填充方法如下：

- 信息字段每一个0x7**E** 字节转变成两个字节——0x7D，0x 5**E**
- 信息字段每一个0x7**D**字节转变为两个字节——0x7D，0x5**D**
- 出现的 ASCII 控制字符（数值小于0x20的字符），则在**该字符前插入0x7D，同时<span style="background:#fff88f">该字符编码加上0x20</span>*dd*

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-08_21-14-10.png" width="600" />
</center>


**零比特填充**

标志字段为 0x7E，二进制编码为 01111110，其中有6个连续的1，则数据字段中不能存在 6 个连续的1。

- 发送端先扫描整个信息字段，若发现连续的 5 个 1，就在其后加上一个 0
- 接收端先找到标志字段 F 确定帧的边界。接着对其中的比特流进行扫描，每当发现连续的 5 个 1，就把后面的 0 删掉

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/Snipaste_2022-10-08_21-21-44.png" width="600" />
</center>


#### PPP 协议的工作状态

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-08_183303.jpg" width="800" />
</center>



---

<br/>


<br/>


## 数据链路层设备

### 网桥

网桥可以把两个或多个以太网连接，构成一个覆盖范围更大的以太网。原来的每个以太网就称为一个网段。

---

<br/>

### 交换机

局域网交换机，又称为以太网交换机。从本质上说，以太网交换机是一个多端口的网桥，他工作在数据链路层。工作原理：检测从以太网端口来的数据帧的源和目的 MAC 地址，与系统内部动态查找表进行比较，若圆 MAC 地址不在查找表中，就添加进去，并将帧发给读经的目的端口。


以太网交换机的特点：
1. 交换机每个端口直接喝某台主机相连（网桥的端口往往连接到一个网段），一般工作在全双工方式。
2. 能同时连通多对端口
3. 即插即用设备，内部转发表通过**自学算法**逐渐建立。
4. 以太网交换机独占传输媒体的带宽

交换机的自学习功能：
- 过滤：决定一个帧是应该转发到某个接口还是应该丢弃。
- 转发：决定一个帧应该被移动到哪个接口称为转发。交换机的过滤和转发借助交换表完成。



----

<br/>


<br/>


<br/>


# 网络层

##  网络层功能

### 虚拟互连网络

用户的需求是多样的，没有一种单一的网络能够使用所有用户的需求。不同网络通过路由器连接起来，由于参与互联的网络都采用 IP 协议，可以把互连以后的网络看成是一个虚拟互连网络，也就是逻辑互连网络。使用 IP 协议可以使这些性能各异的网络在网络层看起来好像是一个统一的网络，覆盖了各网络之间的异构细节。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-24-15-09-01.jpg" width="700" />
</center>

---

<br/>


### 两个层面

- **数据层面**：数据层面的任务是**转发主机和目的主机之间所传送的数据**。路由器根据转发表，把收到的分组，从查找到的对应接口转发出去，通常采用硬件进行转发，转发一个分组的时间为纳秒数量级。
- **控制层面**：根据路由算法，**传递路由信息，在路由器中创建路由表**，并由此导出转发表。由路由算法计算路由要使用软件，速度啊较慢，一般是秒的数量级。最近提出的**软件定义网络 SDN（Software Defined Network）**，对两个层面的接口进行了重大的改变。路由器不再交换路由信息，网络的控制层面有一个在逻辑上集中的远程控制器，掌握各主机和网络的状态，能够为每一个分组计算最佳的路由，然后再路由器中生成正确的转发表。并非把整个互联网都改造成 SDN 控制，适用于大型的专用数据中心之间的广域网。	

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-24-14-38-34.jpg" width="700" />
</center>

---

<br/>


### 两种服务

- **虚电路服务**：电话采取这种面向连接的通信方式，早期有人认为计算机网络也应该采取这种通信方式：当两台计算机进行通信时，**先建立连接**（在分组交换中建立一套虚电路VC（Virtual Circuit）以预留双方通信所需的一切网络资源。然后**双方就沿着已建立的虚电路发送分组**，这样的分组**不需要填写完整的目的主机地址，而只需要填写这条虚电路的编号）**。
- **数据报服务**：电话采取面向连接的通信方式很合适，但是计算机有强大的差错处理能力，所以网络层要设计的尽量简单，向上层只提供简单灵活的、无连接的、尽最大努力交付放入数据报服务。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-24-14-23-31.jpg" width="750" />
</center>

---

<br/>

### 拥堵控制

当某段链路的带宽的利用率超过50%时，网络时延急剧增加。拥堵控制要解决的问题是，获取网络上的拥堵信息，并根据这些信息进行控制。拥堵控制不同于流量控制：

   - **流量控制**：作用于**点对点**链路，抑制发送端发送速率，使得接收端能够来得及接收。
   - **拥堵控制**：确保通信子网能够传输待传输的数据，是个**全局性**的问题。

拥堵控制的方法：

   - 开环控制：静态的预防方法，在设计网络时预先把各种拥堵的因素考虑周全，力求不产生拥堵。
   - 闭环方法：动态方法，在设计网络时不考虑拥堵，而是采用监视网络进行监视，及时将拥堵信息传输到合适地方，以调整网络系统的进行。

---

<br/>


<br/>


## IPv4

网际协议 IP（Internet Protocol）是 TCP/IP 体系中两个最重要协议之一。本小节所讲的是 IP 的第4个版本，简称 IPv4，后面还会讲 IPv6（版本 1-3和版本5 都未曾使用过）。

与协议 IP 配套的还有3个协议：
- **地址解析协议ARP**（Address Resolution Protocol）
- **网际控制报文协议ICMP**（Internet Control Message Protocol）
- **网际组管理协议IGMP**（Internet Group Management Protocol）

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-24-14-48-49.jpg" width="500" />
</center>

---

<br/>


### IP 地址

整个互联网是一个单一的、抽象的网络。IP 地址就是给连接到一个网络的主机的一个接口（所以 **IP 地址和主机并不是一一对应的关系，因为一个主机可以有多张网卡，连接到不同的网络，有多个 IP 地址**）。

#### IP 地址表示法

IP 地址是一个**32位（4 字节）** 的二进制代码，为了提高可读性，每隔8个位就插入一个空格，为了便于人们书写，常用等效的十进制表示，每段数字之间加上一个小数点。这样的写法称为**点分十进制记法**。IP 地址有网络号和主机号组成，一个 IP 地址在整个互联网范围是唯一的。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-24-15-19-45.jpg" width="700" />
</center>

#### 分类的 IP 地址

互联网发展早期是使用分类的 IP 地址，现广泛使用无分类 IP 地址，分类 IP 地址已成为历史。其中 A、B、C 类都是单播地址，D 类地址是多播地址。

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-14_082724.jpg" width="600" />
</center>

A 类地址中主机占三个字节，网络号全为 0 表示保留不指派，网络号 127 保留作为本地软件环回测试本主机的进程之间的通信用。

在每一个网络中，主机号全为 0 表示是一个网络，主机号全为 1 表示所有的主机（广播）。这两个地址不能分配给主机。

可以根据第一个字节来判断网络的类别：
- A 类地址：**0 到127**
- B 类地址：**128 到 191**
- C 类地址：**192 到 223**



#### 无分类编址 CIDR

无分类域间路由选择CIDR（Classless Inter_Domain Routing）

- **网络前缀**：网络前缀即网络号，CIDR采用斜线记法，在IP地址后面加斜线，斜线后面的数字表示网络前缀所占的位数。
- **地址块**：CIDR 把所有网络前缀相同的所有连续的的 IP 地址组成一个 CIDR 地址块。一个较大 CIDR 地址块包含许多较小的地址块，所以在路由器转发表中可以利用一个较大的的 CIDR 地址块来代替许多较小的地址块，这叫做**路由聚合（route aggregation**），CIDR 地址中有几个特殊地址块：
   - 前缀 n=32 ：即 IP 地址全为网络号，只有一个 IP 地址，用于**特定主机路由**。
   - 前缀 n=31 ：只有两个 IP 地址，用于**点对点链路**。
   - 前缀 n=0 ：用于**默认路由**。
- **地址掩码**：计算机不使用斜线记法，而是使用二进制的32位掩码从IP地址快速算出网络地址（按位与运算）。网络前缀对应部分全为1，主机号部分对应全为0。


#### IP地址的特点

- 每一个IP地址都是由网络前缀和主机号两部分组成，IP地址是一个分等级的地址结构。
- IP地址是标记一台主机（或路由器）和一条链路的接口。
- 用交换机连接起来的若干个网络依然是同一个网络，因为具有相同的网络前缀。
- 每一个IP地址都是平等的。

---

<br/>


### 地址解析协议 ARP

ARP 用于在一个网络里面**根据 IP 地址寻找 MAC 地址**，还有一个**逆地址解析协议 RARP，可以根据 MAC 地址查询 IP 地址**，但是 DHCP 已经包括了 RARP 的功能，不再介绍。

**ARP 分组被包装在<span style="background:#fff88f">以太网帧</span>里面**。主机有 ARP 高速缓存用来存放一个从 IP 地址到 MAC 地址的**映射表**（减少网络中的 ARP 报文数量，可以查表就可以不用时刻去询问 MAC 地址），这一个映射表经常依靠 ARP 更新。


ARP工作流程：

- 当 A 主机不知道 B 主机 IP 地址对应的 MAC 地址或 ARP 表对应的项已经老化，就会在网络中广播发送 ARP 请求报文（其中包含 B 主机 IP 地址，A 本机 IP 地址和 MAC 地址）
- 当 B 主机收到 ARP 广播，并发现寻找的对象为自己时，会把 A 主机的信息加入 ARP 表，并给 A 主机单独返回一个 ARP 回复报文。

---

<br/>

### IP 数据报的格式

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-24-18-35-49.jpg" width="700" />
</center>

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/2024-09-14_084423.png" width="750" />
抓包分析
</center>


**首部字段固定部分为 20个字节**。值得注意的点如下：

- 首部长度：**单位为 4 字节**，而且该字段占 4 个位，所以**首部最长不能超过60个字节**。
- 总长度：一个IP数据报的总长度（首部加上被封装的数据）不能超过MTU（1500个字节）。
- 片偏移：**单位为 8 字节**。
- 生存时间：单位为跳，即可以到达的路由器的个数。
- 首部校验和：只检验数据报的首部。

首部校验和的计算：

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-24-18-45-33.jpg" width="600" />
</center>

不妨假设发送端 反码求和 运算结果为  $S$  取反码之后得到 $S'$ ，由于 $S'$ 被填入了校验和里面，所以在**接收端，反码求和运算的结果为 $S+S'$ ，由反码的性质可知，其结果必定是一个全为 1 的序列**，取反码之后，必定是一个全为 0 的序列。

---

<br/>


### IP 层转发分组过程

#### 基于终点的转发

分组在互联网上的传输是基于分组首部的目的地址，这种转发方式成为基于终点的转发。但是路由器并不是直接根据目的地址进行转发的，而是根据分组的网络前缀，找到目的网络之后再交付给目的主机。

#### 最长前缀匹配

由于路由器中会采用路由聚合的方式压缩转发表。所以在进行匹配时，可能会 出现找到多个匹配的项，遇到这种情况时，应该**选择前缀最长的一个作为匹配的网络前缀**。

可以根据网络前缀的长短，**把网络前缀长的项排在路由表的前面**，这样一个 IP 地址从开始匹配时，如果匹配成功，必然是前缀最长的匹配项。

**两类特殊的路由：**
- 主机路由：对特定的目的主机指明一个路由，这种路由就叫做特定主机路由。这个特殊路由的**网络前缀有32位，即没有主机号**。采用特定主机路由可使网络管理人员能够更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。在对网络的连接或路由表进行排错时，指明到某一主机的特定路由就十分有用。主机路由在转发表中放在最前面。
- 默认路由：不管分组在哪里，都由指定的路由器来处理。目的地不在路由器的路由表里的所有数据包都会使用默认路由。在实际的转发表中，采用特殊的网络前缀——**0.0.0.0/0表示默认路由**，可以看出这个网络前缀可以和任何 IP 地址匹配。

**分组转发算法如下：**

- 从收到的分组首部提取目的主机的 IP 地址 D
- 若查找到有特定主机路由，就按照这路路由的下一跳转发分组；否则，就从转发表的下一行开始检测，执行下一步。
- 把**这一行的子网掩码与目的主机 IP 地址进行 AND 运算**。若结果与本行匹配就结束查找，将分组发出，否则，与下一行进行匹配。
- 如果转发表的项查找完了也没有找到匹配的项，就选择默认路由的接口，进行分组转发。

---

<br/>


### 网际控制报文协议 ICMP

为了更有效转发 IP 数据报和提高交付成功的机会，在网络层使用了 ICMP，ICMP 允许主机或路由报告差错情况和提供有关异常情况的报告。


<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-26-16-24-29.jpg" width="400" />
</center>



#### ICMP 报文分类

ICMP 报文分为**差错报告报文**和**询问报文**。其首部的类型字段决定了其类型，常用的 ICMP 报文类型如下：

<center>
<img src="https://picture-in-md.oss-cn-guangzhou.aliyuncs.com/capture-2022-10-26-16-28-36.jpg" width="650" />
</center>

- ICMP差错报告报文：
   - **终点不可到达**：路由器或主机不能交付数据报。
   - **时间超过**：IP数据报每到达一个路由节点生存时间就减一，当一个数据报在路由节点内生存时间减为零，将会丢弃该报文，并返回一个差错报告报文。另外，当终点不能在规定时间内收到数据报的全部报文片时，也会丢弃该数据报。
   - **参数问题**：数据报首部字段的值不正确
   - **改变路由**：找到了更好的路由，下次发送数据，发送给另一个路由。
- 不应该发送差错报文的情况：
   - 对于ICMP差错报告报文，不发送差错报告报文
   - 对于第一个分片的报片和后续所有数据报片
- ICMP询问报文：
   - 回送请求或回送回答：ping
   - 时间戳请求和时间戳回答：利用报文中的时间戳计算出网络的往返时延。
#### ICMP应用

1. 分组网间探测PING（Packet InterNet Groper）：测试两台主机之间连通性，直接使用ICMP，没有通过运输层的TCP和UDP
2. traceroute：跟踪分组从源点到终点的路径。依次发送TTL为1,2,3,4，...直到分组可知到达目的主机。

---

<br/>


<br/>


## VPN与NAT
### 虚拟专用网VPN
当两个专用网之间相隔很远，两者需要通信时，可以利用共用互联网作为本机构各专用网的通信载体，这样的专用网称为虚拟专用网VPN（Virtual Private Network）。
所有通过互联网传送的数据都必须加密。可以采用IP隧道技术实现VPN，把加密后的数据报用IP封装。
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668039697026-6a1c154c-cda2-460d-b08e-1f240e9c4059.jpeg#averageHue=%23f9f9f8&from=url&id=ca1kN&originHeight=768&originWidth=1413&originalType=binary&ratio=1&rotation=0&showTitle=false&size=189048&status=done&style=none&title=" width="600" /> </div>


远程接入VPN：可以利用VPN软件，在主机和服务器之间建立隧道，让主机在异地也可以使用专用网中的资源。
### 网络地址转换NAT
NAT是指将专用网络地址转换为公网地址。有本地IP地址是可重复用的，所以NAT节省了IPv4地址的消耗，同时隐藏了内部网络结构，降低了内部网络受到网络攻击的风险。
私有IP地址网段如下：

   - 1个A类：**10**.0.0.0~**10.**255.255.255
   - 16个B类网段：**172.16.**0.0~**172.31**.255.255
   - 256个C类网段：**192.168.0**.0~**192.168.255.**255

使用NAT时需要在内部网络到公网的路由器上面安装有NAT软件，NAT路由器中又NAT表存放着本地IP地址到全球IP地址的映射。如果只使用IP地址进行映射，一个内网地址只能对应一个全球地址，通常使用一起端口号进行映射，使用端口号的NAT称为网络地址和端口号转换NAPT（Network Address and Port Translation），可以让多个私有IP地址映射到一个全球IP地址。
NAT工作原理：

   - 用户向web服务器发送请求
   - NAT路由器收到IP分组后，生成一个新的端口号，将分组的源IP地址改为公网地址，同时在NAT表增加一个项（包括IP地址的映射，和用户的端口号），将分组发送出去
   - NAT路由器收到Web服务器的响应分组后，根据NAT表，将分组的目的IP地址改为私有IP地址，目的端口该问用户的端口号

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668040080631-75321a72-ffd1-4247-b997-6511304ccbb0.jpeg#averageHue=%23ededec&from=url&id=xIyLt&originHeight=268&originWidth=1425&originalType=binary&ratio=1&rotation=0&showTitle=false&size=130013&status=done&style=none&title=" width="600" /> </div>



## IPv6
### IPv4和IPv6差别

1. 地址长度扩展为原来4倍，IPv6地址占128位。
2. IPv6数据报移除首部校验和字段，减少路由处理时间。
3. 不采用可选字段，而是拓展首部，路由器通常不对拓展首部进行检查，提高路由器工作效率。
4. IPv6支持自动配置，不需要DHCP。
5. IPv6的首部（固定+拓展）长度为8字节整数倍。
6. IPv6只能在主机处分片，IPv4能够在路由处分片。当IPv6分片过长时，路由无法处理（封装给超过底层协议的MTU），只会丢弃并通过ICMPv6返回错误信息。
### IPv6数据格式

1. IPv6数据报由两部分组成，基本首部和有效载荷。其中有效载荷中，允许有零或多个拓展首部。

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1666781322642-107428a8-6358-452c-b758-407c2fec3909.jpeg#averageHue=%23f8f8f8&from=url&id=agH3O&originHeight=361&originWidth=1537&originalType=binary&ratio=1&rotation=0&showTitle=false&size=103859&status=done&style=none&title=" width="600" /> </div>



   - 基本首部：

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1666781394303-a0512cec-9948-495e-ab68-ee5824adfaba.jpeg#averageHue=%23f3f3f2&from=url&height=320&id=EVtnU&originHeight=764&originWidth=1617&originalType=binary&ratio=1&rotation=0&showTitle=false&size=244755&status=done&style=none&title=&width=678" width="678" /> </div>



      - 通信量类：区分不同的IPv6数据报的类别有优先级
      - 流标号：类似IPv4的标识，但标记的不是分片而是流。流是互联网上从从特定源点到特定终点的一系列数据报，所属同一个流的数据报具有相同的流标号。当是非实时数据，置为0。
      - 有效载荷：占16位，所以有效载荷最多为65535个字节。
      - 下一个首部：
         - 当没有拓展首部时，就和IPv4的协议字段一样，他的值指出基本首部后面的数据应该交付给哪一个高层协议。
         - 当出现拓展首部时，字段的值就标识后面第一个拓展首部的类型。
      - 源地址和目的地址：都占128位。
### IPv6的地址

1. IPv6的地址可以分为三种基本类型：
   - 单播：传统的点对点通信
   - 多播：一对多通信，通信对象为一组计算机。
   - 任播：终点是一组计算机，但数据只会交付给其中一台计算机，通常是路由算法得出的距离最近的一个。
2. IPv6把实现IPv6的主机和路由都称为节点，由于一个节点可能与多条链路相连，因此可能会有多个接口，IPv6给每个接口分配一个IPv6地址。
3. IPv6地址的表现形式：
   - 冒号十六进制记法：每16位用十六进制表示，之间用冒号分隔。
   - 零压缩：为了简洁表示，可以将不必要的零省略。
      - 当每16的十六进制表示的部分有前导零时，可以省略，但是不可以省略其他位置的零。
      - 当冒号之间有许多全为零的部分时，可以省略，用两个冒号表示省略，为了不至于混淆，每个IPv6地址只能采用一次这样的零压缩。
### IPv4到IPv6的过渡

1. 双协议栈：主机或路由器同时安装IPv4和IPv6两种协议栈。根据DNS域名系统返回的地址类型，主机需要和什么类型协议的主机通信，就用什么协议栈。但是付出代价太大，最好采用隧道技术。
2. 隧道技术：将IPv6分组封装到IPv4数据报里面，使得IPv6数据可以在IPv4的网络中传输

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1666783499186-b8cb9a6c-1ba7-45b9-bc33-072e7945bb07.jpeg#averageHue=%23f6f6f5&from=url&id=jTQi4&originHeight=625&originWidth=1604&originalType=binary&ratio=1&rotation=0&showTitle=false&size=200604&status=done&style=none&title=" width="600" /> </div>


## 路由选择
### 路由选择算法
#### 静态路由和动态路由

1. 静态路由算法：网络管理员手动配饰路由信息，当网络的拓扑结构或链路状态发生改变时，需要手动修改路由信息。不能及时使用网络状态的变化，但简便和开销小。对于简单小型网络，可以采用这种方法。
2. 动态路由算法：自适应路由算法，通过彼此相连的路由器之间交换信息，按照一定路由算法优化出来路由表。能改善网络性能并有助于流量控制，但是算法复杂，增加了网络负担，有时动态变化太快引起网络震荡，变化太慢影响网络路由一致性。
#### 距离-向量路由算法
所有节点定期将他们整个路由选择表传送给所有与之直接相连的节点，路由选择表包括：

   - 每条路径的目的地（另一个节点）
   - 路径的代价（抽象的概念，不一定是物理距离）

每个节点都监听其它节点发来的路由更新信息。并在一下情况下更新路由选择表：

   - 发现一个新的路由，在原来的路由表中不存在，将新的路由加入路由表
   - 发来的路由信息中有一条到达某个目的地的路由，该路由与当前使用的路由相比，有更小的代价。用经过发送路由信息的节点的新路由替换路由表中达到那个目的地的现有路由。

距离-向量路由算法的本质是，迭代计算一条路由中的代价，从而得到一个到达目标的最小代价通路。要求每个节点在每次更新的时候，将全部路由表发给所有相邻的节点。大的通信子网会有很多更新报文，所以适用于较小的子网。
#### 链路状态路由算法
链路状态路由算法要求每个节点具有完全相同的网络拓扑信息，它们执行以下两项任务。

   - 主动测试所有相邻结点的状态。
   - 定期将链路状态传播给其他所有节点。

当收到链路状态报文时，路由接一单便使用这些状态信息，利用Dijkstra最短路径算法，重新计算路由。
链路状态路由算法主要有以下三个特征：

   - 洪泛法，向本自治系统所有路由发送信息。
   - 发送的信息时与路由相邻的所有路由器的链路状态。
   - 只有当链路状态发生变化时，才向所有路由发送信息。

链路状态路由算法的优点是

   - 每个路由节点使用同样的原始状态数据独立计算路径，不依赖中间节点的计算。（相当于每一个节点都有关于整个网络的地图）
   - 链路状态报文不加改变的传播，易于查找故障。
   - 当一个节点从其他所有节点收到报文时，可以立即在本地算出正确通路，保证一步汇聚。
   - 链路状态报文仅运载一个节点的关于直接链路信息，其大小与路由节点数目无关，有更好的规模可延展性。
#### 路由层次
当网络规模扩大时，路由器的路由表成比例地扩大，会消耗更多路由缓冲区空间，扫描路由表时间更长。因此路由选择按层次的方式进行。
因特网把整个互联网划分为许多较小的自治系统（Autobomous System,AS）（一个自治系统中包含多个局域网），路由选择协议分类两大类：

- 内部网关协议（Interior Gateway Protocol，IGP），也成为域内路由选择，有RIP和OSPF
- 外部网关协议（External Gateway Protocol，EGP），负责分组在不同自治系统之间的选择最优路径，有BGP

使用层次路由时，ODPF又把一个自治系统分为若干区域（Area），采用层次划分使得交换信息种类增多，OSPF协议更复杂，但是每个区域内的内部交换路由信息的通信量大大减小。
### 路由选择协议
#### 路由信息协议RIP
RIP是一种基于距离-向量算法的路由选协议，最大优点是简单。RIP是应用层协议，使用UDP（端口520）传送数据
**RIP规定**

   - 网络中每个路由器都要维护从它自身到其他每个目的网络的距离记录。
   - 将距离定义为跳数（Hop Count），RIP优先选择跳数少的路径。
   - RIP允许一跳路径最多只能包含15个路由器（15跳），当距离大于等于16时，表示网络不可到达。
   - 默认任意两个路由器之间每隔30秒广播一次路由更新信息。
   - 不支持子网掩码的RIP广播，所以每个网络的子网掩码必须相同。但是在最先的RIP2中，支持变长子网掩码和CIDR。

**RIP特点**

   - 只与相邻路由器交换信息
   - 交换的信息时当前路由器知道的所有信息，即自己的路由表
   - 按固定时间间隔交换路由信息。

**RIP工作过程**

   - 对于地址为X的相邻路由器发来的RIP报文，先修改此报文中的信息，将下一跳字段改为X，将距离字段值加1
   - 对于修改后的RIP报文
      - 原来的路由表中没有目的网络N，把该项目添加到路由器
      - 当原来的路由表有目的网络N，而且下一跳为X，根据RIP报文对此项目进行更新。（保证路由表中的项目是最新的）
      - 当原来的路由表有目的网络N，而且下一跳不是X，如果距离更小就更新，否则就不做改动。

RIP最大优点是简单，开销小，缺点如下：

   - 限制网络规模，最大跳数为15
   - 交换完整路由表，网络规模大，开销就越大，拓展性差。
   - 网络出现故障后，收敛慢。
#### 开放最短路径优先OSPF
OSPF协议是使用链路状态路由协议的路由选择协议。
**OSPF协议特点**

   - OSPF向自治系统中所有路由器发送信息，使用洪泛法。
   - OSPF发送的信息为本路由器和相邻路由器的链路状态。
   - 只有当链路状态发送改变的时候，才会使用洪泛法，更新过程收敛快。
   - OSPF是网络层协议，直接使用IP数据报传送。
   - OSPF对不同链路使用不同的指标作为代价，十分灵活
   - 如果存在到同一网络多个代价相同的路径，OSPF可以将通信量分配给几条路径。称为多路径之间的负载平衡。
   - 支持可变长度的子网划分，和无分类编址CIDR
   - 每个链路状态都带上一个32位的序号，序号越大，状态越新。

**OSPF工作原理**
由于各路由器抓紧交换路由信息，所以最终每个路由器都能一个链路状态的数据库（全网拓扑图），然后路由器根据数据库，使用Dijkstra最短路径算法计算从自己重新到各个目的网络的最短路径。但是路由表中并没有完整路径，只有下一跳。
为了使得OSPF能够用于规模很大的网络，将一个自治系统分为若干区域。利用洪泛法的范围仅限于区域，减少了网络上的通信量。区域也有层次之分，处在上层的雨称为主干区域，负责连通其他下层区域，连接其他自治区域。
**OSPF分组类型**
OSPF共有5种分组类型

   - 问候分组：发现和维持相邻站的可达性
   - 数据库描述分组：向邻站发送数据库链路状态项的摘要信息
   - 链路状态请求分组：向对方请求某些链路状态项目的详细信息
   - 链路状态更新分组：洪泛法向全网更新链路状态
   - 链路状态确认分组：对链路更新分组的确认

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1667443418408-4e45893c-e754-41c8-bba0-2f7778967b9b.jpeg#averageHue=%23fbfbfb&from=url&height=233&id=yXnug&originHeight=575&originWidth=1692&originalType=binary&ratio=1&rotation=0&showTitle=false&size=119696&status=done&style=none&title=&width=685" width="685" /> </div>


#### 边界网络协议BGP
边界网关协议（Border Gateway Protocol）是不同自治系统的路由器之间交换路由信息的协议。BGP采用路径向量路由协议，是应用层协议，基于TCP。
BGP只能力求寻找一条能够到达目的网络且比较好的路由，而并非寻找一条最佳路由，主要原因有：

   - 因特网规模太大，自治系统之间路由选择非常困难。
   - 对于自治系统之间的路由选择，寻找最佳路由不现实。（跳数和实际距离偏差大）
   - 自治系统之间的路由选择必须考虑相关策略。

BGP的工作原理：
每个自治系统至少选择一个路由器作为该自治系统的“BGP发言人”。一个“BGP发言人”和其自治系统的“BGP发言人”建立TCP连接，交换BGP报文建立BGP会话。所有发言人都叫唤网络可达性信息后，“BGP发言人”可以根据BGP报文来选择到达某个自治系统的较好路由。
BGP特点：

   - BGP支持CIDR，BGP路由表中包含网络前缀、下一条路由器、以及到达该目的网络所要经过的自治系统序列。
   - BGP刚运行的时候，交换的是整个路由表，之后，只需在发生变化时，更新有变化的部分。

BGP-4的4种报文：

   - 打开（open）报文：和相邻的“BGP发言人”建立关系。
   - 更新（Update）报文：用来发送某一路由的信息，以及列出要撤销的多条路由。
   - 保活（Keepalive）报文：用来确认打开报文，并周期性地证实邻站关系。
   - 通知（Notification）报文：用来发送检测到的差错。

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1667525487549-79884f97-a6f5-47b4-a6b4-1d0e53b9bf41.png#averageHue=%23e7e7e7&clientId=u8d610bb0-ee14-4&from=ui&id=u923334d9&originHeight=693&originWidth=1570&originalType=binary&ratio=1&rotation=0&showTitle=false&size=250849&status=done&style=none&taskId=ua4509e41-6202-4e37-98b2-67281fcb636&title=" width="600" /> </div>


## IP组播
### 基本概念
计算机一次发送单个分组可以抵达用同一组地址标识的若干主机。多播大大节省了网络资源，分组只需要发送一次，只有在路由器需要复制时才进行复制。
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668000270141-39982131-161b-4362-abe4-8673b993fefd.jpeg#averageHue=%23f7f7f7&from=url&id=zq4Gg&originHeight=588&originWidth=1478&originalType=binary&ratio=1&rotation=0&showTitle=false&size=171524&status=done&style=none&title=" width="600" /> </div>



- 组播一定仅应用于UDP，这样才能同时有多个接收者。
- 能运行多播协议的路由器称为多播路由器，多播路由器也能转发普通IP数据报。
- 多播组的标识符就是IP地址中的D类地址。前4位为1110
- 对于多播数据报不产生ICMP差错报文。
### 局域网硬件多播
以太网组播地址的范围为01-00-5E-00-00-00到01-00-5E-7F-FF-FF
以太网组播地址的后23为和IP组播地址存在一一对应的关系：
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668001205409-5aa27b7c-f13b-405b-bfa2-a24607960b41.jpeg#averageHue=%23f7f7f7&from=url&height=496&id=Jx9Oh&originHeight=500&originWidth=1855&originalType=binary&ratio=1&rotation=0&showTitle=false&size=167251&status=done&style=none&title=&width=1840" width="600" /> </div>


### 网际组管理协议IGMP
网际组管理协议IGMP（Internet Group Management Protocol）让多播路由器知道组播成员的信息，以便于处理多播数据报。
IGMP的使用范围时本地，IGMP让连接在本地局域网的多播路由器知道本局域网上是否有主机加入或退出了多播组。
IGMP工作工程：

   - 当某台主机加入新的多播组时，该主机应向多播组的多播地址发送一个IGMP报文，声明自己要成为该组的成员。当本地的多播路由器收到IGMP报文后，还有利用多播路由选择协议将这种组成员关系发给其他多播路由器。
   - 组成员的关系是动态的。本地多播路由器要周期性探询本地局域网的主机，以便于知道这些主机是否还是组的成员。

仅仅依靠IGMP是不能实现IP多播的，还要路由器的多播路由选择协议，为多播数据报选择合适的处理方法。多播路由选择实际上就是找出以源主机为根节点的多播转发树。
## 移动IP
移动IP技术是指移动节点以固定的网络IP地址实现不同网段的漫游功能，并保证网络IP的权限在漫游过程中不发生任何改变
基于IPv4的移动IP定义3种功能实体：

   - 移动节点：具有永久IP地址的移动节点。
   - 本地代理：移动节点的永久归属网络
   - 外部代理：在外部网络帮组移动节点弯沉移动管理功能的实体。

移动IP的工作过程：

   - 移动节点在本地网时，正常通信。
   - 移动节点漫游到一个外地网络时，移动节点向本地代理注册当前点位置地址，这个地址就是转交地址。
   - 本地代理接收注册后，构建一条通向转交地址的隧道，将截获的发给移动节点的分组通过隧道转发到转交地址。
   - 在转交地址处解除隧道封装，恢复原始IP分组，最后移动节点收到IP分组。
   - 移动节点在外网时通过外部代理向通信对端发送IP数据报。
   - 当移动节点回到本地网时，移动节点向本地代理注销转交地址。
## 网络层设备
### 冲突域和广播域

   - 冲突域：连接到同一物理介质的所有节点的集合。这些节点之间存在介质争用的现象。2层及以上的设备可以划分冲突域。
   - 广播域：能接收到同样广播信息的节点集合。第一层和第二层设备连接的所有节点都属于同一个广播域。第3层设备可以划分不同广播域，也就是连接不同广播域。
### 路由器组成和功能
路由器是一种具有多个输入/输出端口的专用计算机，其任务是连接不同的网络，并完成路由转发。路由器可以分为路由选择和路由转发部分。

   - 路由选择部分：核心构件是路由器选择处理机，根据路由协议构造出路由表。
   - 分组转发部分：由三部分组成：交换结构、输入端口和输出端口。输入端口从物理层接收比特流，然后逐层分解，提取出数据报，输出端口则执行相反的过程。

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668043906271-7ba79976-4d18-40db-a3c9-5e11b4fc577d.jpeg#averageHue=%23fafaf9&from=url&id=s1Poo&originHeight=479&originWidth=1257&originalType=binary&ratio=1&rotation=0&showTitle=false&size=103609&status=done&style=none&title=" width="600" /> </div>


### 路由表和路由转发
路由表是根据路由选择算法得出来的，主要用途是路由选择，标准路由表中主要包含4个项目：目的网络IP地址、子网掩码、下一跳IP地址、接口。
转发表是从路由表的出的，其表项和路由表有直接的对应关系。其表项和路由表有直接对应关系。但是转发表格式和路由表的格式不同，其结构应是查找过程最优化。
# 运输层
## 运输层概述
### 进程之间的通信
运输层项应用层提供通信服务，负责进程之间的通信。
应用层的功能有——复用和分用，复用就是发送方不同应用进程都可以使用同一个运输层协议传送数据，分用指接收方在运输层分离首部后能够把数据正确交付给目的应用进程。
运输层还会对报文进行差错检测。
### 两个主要协议
运输层两个主要协议——传输控制协议TCP（Transmission Control Protocol）和用户数据报协议UDP（User Dategram Protocol），对应的PDU分别称为TCP报文段（Segment）和UDP用户数据报。
TCP提供面向连接的服务，UDP则不需要先建立连接。
### 运输层端口
运输层提供进程之间的通信，需要标记不同进程。单个计算机的进程用进程标识符来标志，但是网络中计算机的操作系统种类多，不同操作系统使用不同格式的进程标志符，同时把特定机器上的进程指明为网络通信的终点也是不可行的，因为进程的创建和撤销都是动态的。
端口就是通信的抽象终点，TCP/IP中用一个16位的端口号来标志端口，端口号只具有本地意义，用于标志本计算机进程和运输层交互时的层间接口。
运输层端口可以分为两类：

   - 服务器使用的端口：
      - 熟知端口（well-known port number）：数值为1~1023

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668647161430-02ac6059-72ea-4a70-a05e-bc552e75f23d.jpeg#averageHue=%23f3f3f2&from=url&height=195&id=TStys&originHeight=200&originWidth=1457&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74824&status=done&style=none&title=&width=1424" width="600" /> </div>



      - 登记端口：数值为1024~49151，为没有熟知端口号的应用使用。
   - 客户端端口：数值为49152~65535，仅在客户进程中运行时才动态选择。
## 用户数据报协议UDP
### UDP概述
UDP仅在IP的数据报服务之上增加了很少的功能——复用、分用和差错检测，这也是运输层至少要提供的服务。
UDP的特点：

   - 无连接：通行前不需要实现建立连接。
   - 尽最大努力交付：不保证可靠交付，简化了协议。
   - 面向报文：对于应用程序交下来的报文，在增加首部之后，直接交付给网络层，既不合并也不拆分。

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668647628362-1dcf6741-ddfb-4295-a1e6-2460ee6410dd.jpeg#averageHue=%23f5f5f4&from=url&id=LidaA&originHeight=338&originWidth=1413&originalType=binary&ratio=1&rotation=0&showTitle=false&size=84291&status=done&style=none&title=" width="600" /> </div>



   - 没有拥塞控制：网络拥塞不会使源主机发送速率下降，符合实时应用（视频会议，网络电话）的要求。但是网络很多主机都向网络发送实时视频流量，网络有可能发生严重拥塞，倒置所有主机都正常收到。
   - 首部开销小
   - 支持一对多和多对多交互通信：因为事先不需要建立连接。
### UDP首部格式
UDP数据报由4个字段组成，每个字段长度都是两个字节。
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668648508268-3e767aaf-841f-496e-a48f-b3011b1d12eb.jpeg#averageHue=%23f5f4f4&from=url&id=niKXm&originHeight=472&originWidth=1388&originalType=binary&ratio=1&rotation=0&showTitle=false&size=128181&status=done&style=none&title=" width="600" /> </div>



   - 源端口：需要对方回复时选用，不需要时全用0。
   - 目的端口
   - 长度：UDP数据报的长度。
   - 检验和：UDP检验和的计算和IP检验的计算原理一样。不同的点有：UDP数据报在计算检验和时需要添加伪首部（源IP地址和目的IP地址，一共8字节），检验和的校验部分为整个UDP数据报加上伪首部。
## 传输控制协议TCP概述
**TCP的特点**

   - 面向连接：传输数据前事先建立连接，传输完成后关闭连接。
   - 点对点通信：
   - 提供可靠交付
   - 提供全双工通信：连接双方能同时发送信息
   - 面向字节流：流是流入进程或进程流出的字节序列，面向字节流是指TCP把应用交下来的数据仅仅看成是一连串无结构的字节流，接收方的应用程序必须有能力把接受到的字节流还原。

**TCP连接**
每一条TCP连接都有端点，TCP连接的端点是套接字（socket），端口号拼接到IP地址后面就构成了套接字。
$套接字 socket=(IP地址，端口号)$
**TCP首部格式**
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1668650838571-a37bfcb0-110c-4f63-975c-2f60e72a48f1.jpeg#averageHue=%23f7f7f6&from=url&id=CPRof&originHeight=699&originWidth=1437&originalType=binary&ratio=1&rotation=0&showTitle=false&size=177847&status=done&style=none&title=" width="600" /> </div>



   - 序号：4个字节，，TCP连接面向字节流，所以每个字节都按顺序编号，本报文段的序号表明该报文段中发送的第一个字节的序号。
   - 确认号：4个字节，期望收到对方下一个报文段的第一个数据字节的序号。
   - 数据偏移：4个字节，指明报文段的数据起始处距离TCP报文的起始处有多远，其单位为4字节，因为首部有不确定的可选部分。
   -  紧急URG：当URG为1时，该字段有效，表明该报文段中有紧急数据，发送方TCP会把紧急数据插入本报文段数据部分的最前面。该字段需要和紧急指针字段配合使用。
   - 确认ACK：当字段值为1时，确认号有效。
   - 推送PSH：当应用进程在进行交互时，一端的应用进程需要立即收到对方响应，发送方把PSH字段设置为1，并立即创建一个报文段发送出去，接收方在收到该报文段后，就尽快交付应用进程，而不是等到这个缓存都填满后再交付。
   - 复位RST：释放连接，重新建立连接。
   - 同步SYN：在建立连接时同步序号。
   - 中止FIN：释放一个连接。
   - 窗口：2个字节，指明发送方的接收窗口，即允许对方发送的数据量。
   - 校验和：和UDP校验和计算一样。
   - 紧急指针：和紧急URG字段配合使用，指明紧急数据的末尾在报文段中的位置。
## TCP可靠传输
可靠传输机制相关的停止等待协议，GBN协议，SR协议已经在[数据链路层可靠传输机制](#NqCw0)有所提及，下面对之前未提及的内容作补充。
### 超时重传时间的选择
超时时间必然大于RTT，TCP采用了一种自适应算法，来估算RTT
TCP仅在某个时刻做一次SimpleRTT的测量，由于路由器的拥塞和端系统负载的变化，SampleRTT会随之波动，为了得到一个典型的RTT，TCP会维持一个SampleRTT的均值EstimatedRTT：
$EstimatedRTT=\left( 1-\alpha \right) \cdot EstimatedRTT+\alpha \cdot SampleRTT$
[RFC6298]中推荐的 $\alpha$值为0.125，同时[RFC6298]定义类RTT偏差DevRTT用于估算Sample偏离EstimatedRTT的程度：
$DevRTT=\left( 1-\beta \right) \cdot DevRTT+\beta \cdot \left| SampleRTT-EstimatedRTT \right|$
其中$\beta$的推荐值为0.25
由此可以根据DevRTT和EstmatedRTT来计算超时时间：
$TimeoutInterval=EstimatedRTT+4\cdot DevRTT$
### 选择确认SACK
当收到的报文段没有差错，但是	没有按照序号，中间还缺少一些序号的数据，可以使用选择确认SACK。如果使用选择确认SACK，在建立TCP连接时，需要双方进行协商，在首部加上允许SACK。
SACK需要指明选择确认序号的起点和终点，即至少需要8个字节，还需要一个字节指明是SACK选项，还需要一个字节指明这个选项需要多少字节。由此可以推出，SACK选项中，最多可以指明4个字节块的边界信息，因为5个字节块需要42字节的选项长度，超出了选项部分40字节的上限。
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1669634152486-892ce30a-9f8a-4978-80e9-af0ce668c889.png#averageHue=%23fbfbfb&clientId=u7a243da5-3f92-4&from=ui&id=u2cdafc02&originHeight=379&originWidth=1725&originalType=binary&ratio=1&rotation=0&showTitle=false&size=165446&status=done&style=none&taskId=u038a5419-a42a-4c90-b2d1-e78eece205d&title=" width="600" /> </div>


### TCP流量控制
#### 滑动窗口实现流量控制
流量控制就是控制发送方的发送数据的速率使得接收方可以接收数据。
TCP在ACK确认报文中，使用rwnd（reciever window）来指明接收方当前可用的接收窗口，单位为字节。发送方在收到ACK报文后就不会发送数据长度大于rwnd的报文段。
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1669635313816-f56d3c46-c39a-4482-b222-fe1e647a0d91.png#averageHue=%23fade8f&clientId=u7a243da5-3f92-4&from=ui&id=ua485cfad&originHeight=667&originWidth=1587&originalType=binary&ratio=1&rotation=0&showTitle=false&size=372252&status=done&style=none&taskId=uabed8dab-500e-4738-a278-270df28b561&title=" width="600" /> </div>


当发送方收到rwnd=0的ACK报文后，就停止发送数据，直到接收方发送非零窗口通知，但是如果非零窗口通知丢失，发送方会一直等待非零窗口通知，而接收方会一直等待发送方的数据，这样就是陷入死锁状态。
为了解决这个问题，TCP为每个连接设立一个持续计时器，只要收到对方零窗口通知就启动持续计时器，当计时器超时还没收到非零窗口通知，就发送一个零窗口探测报文（仅携带一个字节信息），如果收到的ACK报文还是零窗口就重置计时器。重复以上过程直到收到非零窗口通知。
#### TCP传输效率
TCP发送数据时机选择

   - 策略一：在建立TCP连接时，双方会协商各自允许接收的最大报文数据长度MSS，当发送方缓存的要发送的数据达到MSS时，就发送数据。
   - 策略二：发送方收到push操作就立即把数据发送出去。
   - 策略三：当发送方计时器到期，就把缓存的数据发送出去。

在TCP实现中广泛使用的是Neggle算法，Nagle算法只允许一个未被ACK的包存在于网络，它并不管包的大小，因此它事实上就是一个扩展的停-等协议，只不过它是基于包停-等的，而不是基于字节停-等的。
糊涂窗口综合症：接收方的缓存区已满，而接收方的交互进程一次只读取一个字节数据，然后返回一个ACK将rwnd设置为1，接下来发送方发送只含有一个字节的报文段，使得网络效率很低。要解决以上问题，可以让接收方等待一段时间，等缓冲区可以容纳MSS字节，或有一半空余就发送ACK确认，让发送方发送报文。
### TCP拥堵控制

# 应用层
应用层协议目的是是解决某一类应用问题，问题的解决需要位于不同主机中的多个应用进程之间的通信和协同工作来完成。应用层的具体内容就是精确定义这些通信规则，具体来说应用层协议应当定义：

- 应用进程交换的报文类型，如，请求报文和响应报文
- 各种报文类型的语法，即包含的各种字段及其详细描述
- 字段的语义，包含在字段中的信息的含义
- 进程何时、如何发送报文，以及对报文进行相应的规则
## DNS域名系统
将域名转化为IP地址的系统，联机分布式数据库系统，客户把待解析的域名放在DNS请求报文（减少开销）里面，以UDP数据包的形式发送给本地域名服务器，查找到IP地址后，将IP地址放在回答报文中返回
为何使用IP地址而不是域名进行寻址？

- IP地址不方便记忆
- 域名不是定长的，不利于机器处理
### 域名结构
域名由标号序列组成，每一个标号用点隔开
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663637271555-ed3232bc-dd89-40ae-ae85-6ee2dedf6972.jpeg#averageHue=%23f7f7f7&from=url&height=64&id=qcXBI&originHeight=230&originWidth=882&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37410&status=done&style=none&title=&width=247" width="247" /> </div>



- 根域名：13台 A-M 根域名服务器，但是全球各地有多个映像
- 顶级域名
   - 国家顶级域名：如，.cn 
   - 通用顶级域名：如，.com
   - 基础结构域名：arpa（Address and Routing Parameter Area），用于反向域名解析
- 国家顶级域名下的二级域名有国家自行定义

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663637913637-05b2017e-f17a-4382-bd0d-248789301b08.jpeg#averageHue=%23fbfbfb&from=url&height=180&id=vdDUr&originHeight=464&originWidth=1330&originalType=binary&ratio=1&rotation=0&showTitle=false&size=92966&status=done&style=none&title=&width=515" width="515" /> </div>


### 域名服务器
DNS服务器的管辖范围不是以“域”为单位，而是区（zone），区小于或等于域。每一个区设置相应的权限域名服务器，保存该区中所有主机的域名到IP地址之间的映射关系
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663658510713-d9281f05-7ebf-4e1d-a189-213bdb5da7b1.jpeg#averageHue=%23faf9f9&from=url&height=203&id=vO16a&originHeight=524&originWidth=1455&originalType=binary&ratio=1&rotation=0&showTitle=false&size=169357&status=done&style=none&title=&width=564" width="564" /> </div>



- 根域名服务器：13台 A-M 根域名服务器，即a.rootservers.net~m.rootservers.net，和多个映像
   - 并不会直接返回域名对应的IP地址（在根域名服务器中虽然没有每个域名的具体信息，但储存了负责每个域的解析的域名服务器的地址），而是告诉本地域名服务器下一步应该找哪一个服务器
- 顶级域名服务器（TLD服务器）：负管理在在顶级域名之下注册的二级域名，返回对应的回答或者下一步查找的域名服务器的IP地址
- 权限域名服务器：负责一个区的域名服务器，返回对应回答或者下一步应该查找的域名服务器地址
> 权限域名服务器是经过上一级授权对域名进行解析的服务器，同时它可以把解析授权转授给其他人，如COM顶级服务器可以授权ABC.COM的权威服务器为NS.ABC.COM，同时NS.ABC.COM还可以把授权转授给NS.DDD.COM，这样NS.DDD.COM就成了ABC.COM实际上的权威服务器了

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663671684122-702319f4-0b9b-488b-a45f-03627080a16a.jpeg#averageHue=%23faf9f9&from=url&height=191&id=iSfuG&originHeight=491&originWidth=1440&originalType=binary&ratio=1&rotation=0&showTitle=false&size=118591&status=done&style=none&title=&width=559" width="559" /> </div>



- 本地域名服务器：不属于以上的域名服务器结构，当一台主句发出DNS查询请求时，这个查询请求报文就发送给办本地域名服务器，如果要查询的主机属于同一个本地ISP时，本地服务器可以立即返回IP地址，不用去查询其他域名服务器
> - **本地域名服务器和权限域名服务器的区别：**
>    - 登录访问不同：本地域名服务器是任何人都可以登录访问的。授权域名服务器只有授权的用户角色才可以登录访问的。
>    - 查询不同：本地域名服务器可以以DNS客户的身份向某一个根域名服务器查询。授权域名服务器不能向根域名服务器查询。
>    - 操作不同：本地域名服务器的操作不受限制，有最高操作权限。授权域名服务器根据设置的特定权限角色不同，操作也不同。

- 主域名服务器和辅助域名服务器：主域名服务器定期把数据复制到辅助域名服务器中，而更改数据只能在主域名服务器中进行。提高域名服务器的可靠性
- 域名解析过程
   - 递归查询：一般用于主机向本地域名服务器查询过程。也就是说，如果本地主机所询问的本地域名服务器不知道被查询域名的IP地址，那么本地域名服务器就以DNS客户的身份，向根域名服务器继续发出查询请求报文（即替主机继续查询），而不是让主机自己进行下一步的查询。
   - 迭代查询：通常用于本地域名服务器向根域名服务器的查询过程。

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663673698243-020f8bba-462b-4ef5-b141-34946b3aef6b.jpeg#averageHue=%23fafafa&clientId=u4854937d-a7ee-4&from=ui&height=342&id=u8417f8a0&originHeight=570&originWidth=653&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45849&status=done&style=none&taskId=ubb2d0bc9-e64b-43e3-8539-accf08ed249&title=&width=392" width="392" /> </div>



   - 举例说明域名解析的过程，假设某客户想要获知域名为y.abc.com主机的IP地址，域名解析的过程（共使用8个UDP报文）如下：
      1. 客户机向本地域名服务器发出DNS请求报文
      2. 本地域名服务器收到请求后，查询本地缓存，若没有该记录，则以DNS客户的身份向根域名服务器发出解析请求
      3. 根域名服务器收到请求后，判断该域名属于.com域，将对应额顶级域名服务器的dns.com的IP地址返回给本地域名服务器
      4. 本地域名服务器向顶级域名服务器dns.com发出解析请求报文
      5. 顶级域名服务器dns.com收到请求后，判断该域名属于abc.com.将对应的授权域名服务器dns.abc.com的IP地址返回给本地域名服务器
      6. 本地域名服务器向授权域名服务器dns.abc.com发起解析请求报文
      7. 授权域名服务器dns.abc.com收到请求后，将查询结果返回给本地域名服务器
      8. 本地域名服务器将查询结果保存到本地缓存，同时返回给客户机
> - DNS缓存
>    - 高速缓存用来存放最近查询的域名以及从何处获得域名映射信息，主机可以存储，本地DNS服务器也可以存储
>    - 优点：提高DNS查询效率，减轻根服务器的负荷。
>    - 缺点：DNS缓存需要消耗一定的系统资源，增加了域名系统的复杂性。此外TTL值的设置对于平衡DNS解析速度和精度产生了较大影响。

## 文件传输协议FTP
文件传输协议（File Transfer Protlcol）提供交互时的访问，允许客户指明文件的类型与格式，允许文件具有存取权限（需经过授权）
### FTP工作原理
FTP采用客户服务器方式，FTP服务器有两大部分组成：主进程和从属进程。

- 主进程的工作步骤
   - 打开默认端口（端口号21），使客户进程能够连接上
   - 等待客户进程发出连接请求
   - 启动从属进程处理客户进程发来的请求，从属进程处理完请求后即中值
   - 回到等待状态，继续处理其他客户进程发来的请求
> **FTP协议的工作方式**
> FTP支持两种模式，一种方式叫做Standard (也就是 PORT方式，主动方式)，一种是 Passive (也就是PASV，被动方式)。Standard模式 FTP的客户端发送 PORT 命令到FTP服务器。Passive模式FTP的客户端发送 PASV命令到 FTP Server。
> - **Port模式，**FTP客户端首先动态的选择一个端口（一般是1024以上的）和FTP服务器的TCP 21端口建立连接，通过这个通道发送命令，客户端需要接收数据的时候在这个通道上发送PORT命令。PORT命令包含了客户端用什么端口接收数据。在传送数据的时候，服务器端通过自己的TCP 20端口连接至客户端的指定端口发送数据。
> 
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1663722037975-b4cc4f69-e317-4140-8b75-ce79dd50b84a.png#averageHue=%23fafafa&clientId=u6ff42d00-ba93-4&from=ui&height=286&id=u60f8f1e1&originHeight=512&originWidth=707&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31792&status=done&style=none&taskId=u1a9434f8-c7b6-4730-ba28-44b21563d65&title=&width=395" width="395" /> </div>


> - **Passive模式**，在建立控制通道的时候和Standard模式类似，但建立连接后发送的不是Port命令，而是Pasv命令。FTP协议服务器收到Pasv命令后，随机打开一个高端端口（端口号大于1024）并且通知客户端在这个端口上传送数据的请求，客户端连接FTP服务器此端口，然后FTP服务器将通过这个端口进行数据的传送。
> 
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1663722090362-5e297f27-4ba5-4413-9d39-1a37f96108bb.png#averageHue=%23fbfbfb&clientId=u6ff42d00-ba93-4&from=ui&height=286&id=u3570c107&originHeight=571&originWidth=842&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38837&status=done&style=none&taskId=u103568c9-53a1-4139-8eb7-8efbc6f3228&title=&width=422" width="422" /> </div>


> 很多防火墙在设置的时候都是不允许接受外部发起的连接的，所以许多位于防火墙后或内网的FTP服务器不支持PASV模式，因为客户端无法穿过防火墙打开FTP服务器的高端端口；而许多内网的客户端不能用PORT模式登陆FTP服务器，因为从服务器的 TCP 20无法和内部网络的客户端建立一个新的连接，造成无法工作。 

### 控制连接和数据连接

- 两个主要的从属进程：控制进程和数据传送进程，分别对应两个TCP连接——控制连接和数据连接。控制连接在整个会话期间会一直保持打开，服务器端的控制进程在受到FTP客户的文件传输请求后就创建“数据传送进程”和“数据连接”（默认端口20），用来连接客户端和服务器端的数据传送进程，在数据传输结束后，关闭数据传输连接冰结束运行。

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663677730749-24941f30-3cef-4344-9f78-a4bcb6d79329.jpeg#averageHue=%23f6f6f5&from=url&height=168&id=lK7Wx&originHeight=437&originWidth=1610&originalType=binary&ratio=1&rotation=0&showTitle=false&size=126667&status=done&style=none&title=&width=619" width="619" /> </div>


## 万维网WWW
### WWW
万维网（World Wide Web）是一个分布式（万维网把大量信息分在整个网络上面，每台主机的文档独立进行管理，对文档进行改动并不需要通知其他主机。）的超媒体（hypermedia）系统，是超文本（hypertext）系统的补充。
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1663724192418-8870109b-8507-4561-8be0-636a33478b6a.png#averageHue=%23fcfaf7&clientId=u6ff42d00-ba93-4&from=ui&height=196&id=uf539b64c&originHeight=398&originWidth=718&originalType=binary&ratio=1&rotation=0&showTitle=false&size=92517&status=done&style=none&taskId=uff1a6984-87c1-4cdc-a763-0cb0cc02353&title=&width=353" width="353" /> </div>


> 超媒体和超文本的区别是文档内容不同，超文本文档仅包含文本信息，超媒体文档还包含其他表示方式的信息，如图形、图像、声音、动画以及视频图像

万维网采用客户服务器方式工作。客户程序向服务器发出请求，服务器程序返回对应的万维网文档。在一个客户程序主窗口显示出的万维网文档称为页面。
万维网需要解决的问题：（1）怎么标记分布在万维网上面的文档。（2）怎么创作不同风格而且在别的主机上可以显示出来的文档，同时使客户清除哪里存在链接。（3）用上面协议实现万维网上各种连接。

- 统一资源定位符URL
   - URL（Uniform Resource Locator）是标识Internet网上资源位置而设置的一种编址方式，是互联网上的资源的位置和访问方法的简洁表示，是互联网资源的地址，网络上每个文件都有唯一的URL，可以看作一个文件名在网络范围的拓展
   - URL的结构如下，协议和主机名不分大小写，路径可能要区分大小写

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663725316121-35e8336c-e4fb-4a1a-9d92-b453bd0eda84.jpeg#averageHue=%23fcfcfc&from=url&height=200&id=ZEhRW&originHeight=200&originWidth=1469&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35302&status=done&style=none&title=&width=1469" width="600" /> </div>



      - 协议：通常为http协议，也可以是ftp等协议
      - 主机名：万维网文档所存放的主机的域名，通常以www.开头（可以省略）。主机名用点分十进制的IP地址代替也是可以的
      - 端口：协议的默认端口号，通常被省略，因为协议默认端口号固定（http为80）
      - 路径：资源在服务器主机中的位置路径，可以省略，省略则URL指明互联网上的某个主页（home page）
> - URI、URL和URN之间区别
>    - URI（Uniform Resource Identifier，统一资源标识符)是一个用于标识某一互联网资源名称的字符串。 该种标识允许用户对网络中（一般指万维网）的资源通过特定的协议进行交互操作。
> 
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1663729736908-c9de1e1b-58a1-4959-9d24-9e32e3f03a7d.png#averageHue=%23fcfaf9&clientId=u6ba3e830-ad0b-4&from=ui&height=197&id=u93684288&originHeight=1217&originWidth=2559&originalType=binary&ratio=1&rotation=0&showTitle=false&size=626361&status=done&style=none&taskId=uebecbb90-d3c1-45a1-a8f1-048184650b0&title=&width=414" width="414" /> </div>


>    - URL(Uniform Resource Locator，统一资源定位符），最常见的形式是 URI,经常指定为非正式的网址。
>    - URN（Uniform Resource Name，统一资源名称），其目的是通过提供一种途径，用于在特定的命名空间资源的标识，以补充网址。资源位置变动会使URL失效，但是URN不受文件位置影响，但需要解析器，根据名字解析出资源的位置以进行访问，要求高，较少使用

- 万维网文档
   - 超文本标记语言HTML（HyperText  Markup  Language）：一种制作万维网页面的标准语言，其中定义了许多关于排版的命令，即"标签"（tag）。
   - 层叠样式标CSS（Cascading Style Sheets）：一种样式表语言，用于HTML文档定义布局，HTML用于格式化内容，CSS用于格式化结构化的内容。
   - 动态万维网文档：
      - 静态文档：文档创作完成后就存放在万维网服务器当中，在被用户浏览的过程中内容不会改变
      - 动态文档：文档的内容是在浏览器访问服务器时才由应用程序创建。静态文档和动态文档的差别主要是文档内容的生成方法不同。
      - 通用网关接口GCI（Common Gateway Interface）：一种标准，定义动态文档应该如何创建，输入数据应如何提供给应用程序，以及输出结果应如何使用

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663920895566-b3b11781-7438-43f5-a4ed-665989c9aa84.jpeg#averageHue=%23f7f6f6&from=url&height=165&id=QpWa4&originHeight=467&originWidth=1335&originalType=binary&ratio=1&rotation=0&showTitle=false&size=135200&status=done&style=none&title=&width=471" width="471" /> </div>



   - 活动万维网文档：把所有的工作都转移给浏览器端，每当浏览器请求一个活动文档时，就返回一段活动文档的副本，使该程序副本在浏览器运行。活动文档本身并不包含其运行所需全部软件，大部分支持软件是事先存放在浏览器的。
### HTTP
HTTP协议定义了客户进程怎么向万维网服务器请求万维网文档，以及服务器怎么把文档传送给浏览器。
#### HTTP工作过程
服务器进程监听TCP端口80，发现客户进程的连接请求后建立TCP连接，之后客户端向服务器发送请求，服务器进行应答，完成任务后释放TCP连接。
<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663921978497-16aa93c9-b1ce-4223-accd-d76343f94d80.jpeg#averageHue=%23f8f8f7&from=url&height=210&id=Uzj4j&originHeight=564&originWidth=1296&originalType=binary&ratio=1&rotation=0&showTitle=false&size=130054&status=done&style=none&title=&width=483" width="483" /> </div>


#### 无连接、无状态（stateless）

- 无连接：无连接的含义是限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。
   - 早期客户端和服务器之间交换数据间歇较大（传输具有突发性、瞬时性），并且网页浏览的联想性、发散性导致两次数据传输关联性很低，信道空闲，无连接可以尽快将资源释放出来以便于服务其他客户。
   - 后来网页越来越复杂，一个网页中可能嵌入了很多其他资源，每请求一个资源就建立一个TCP连接显得很低效。Keep-Alive 功能使客户端到服务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive 功能避免了建立或者重新建立连接。使用，Keep-Alive功能后，客户端和服务器之间的 HTTP 连接就会被保持，不会断开(超过 Keep-Alive 规定的时间，意外断电等情况除外)，当客户端发送另外一个请求时，就使用这条已经建立的连接。
   - HTTP 协议这种特性有优点也有缺点，优点在于解放了服务器，每一次请求“点到为止”不会造成不必要连接占用，缺点在于每次请求会传输大量重复的内容信息。
   - HTTP/1.1的持续连接：在HTTP1.0中，默认的是短连接，没有正式规定 Connection:Keep-alive 操作；在HTTP1.1中所有连接都是Keep-alive的，也就是默认都是持续连接的（Persistent Connection）。

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/png/29674612/1663985175225-f1429977-52e2-4942-8560-89c65fab5c28.png#averageHue=%23020000&clientId=u4ed45a97-63fe-4&from=ui&height=186&id=u09426936&originHeight=280&originWidth=450&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18892&status=done&style=none&taskId=ubdf4b65b-9a79-43b9-ac2f-56ee43913f2&title=&width=299" width="299" /> </div>


> - HTTP/1.1逐渐停止了对keep-alive连接的支持，用一种名为持久连接的改进型设计取代了它。持久连接的目的与keep-alive连接的目的相同，但是工作机制更优些。HTTP/1.1就吃连接在默认情况下是激活的，除非特别指明，否则HTTP/1.1假定所有的连接都是持久的，要在事务处理结束之后将连接关闭，HTTP/1.1应用程序必须向报文中显示地添加一个Connection：close首部。
> - HTTP1.1客户端加载在收到响应后，除非响应中包含了Connection：close首部，不然HTTP/1.1连接就仍然维持在打开状态。但是，客户端和服务器仍然可以随时关闭空闲的连接。不发送Connection：close并不意味这服务器承诺永远将连接保持在打开状态。

      - 非流水线方式：客户收到前一个响应才能发送下一个请求
      - 流水线方式：客户在收到前一个请求的响应之前就能发送下一个请求
> - 即使采取了流水线方式，单服务器发回响应时必须顺序排队，逐个发给客户，有时遇到某个响应迟迟不能发回，后面的响应就必须排队，未解决这个问题HTTP/2采取多路复用的方式。

   - HTTP/2多路复用：多路复用代替原来的序列和阻塞机制，所有就是请求的都是通过一个 TCP 连接并发完成。同时也很好的解决了浏览器限制同一个域名下的请求数量的问题。
> - 在 HTTP/2 中，有了二进制分帧之后，HTTP/2 不再依赖 TCP 链接去实现多流并行了，在 HTTP/2 中：
>    - 同域名下所有通信都在单个连接上完成，同个域名只需要占用一个 TCP 连接，使用一个连接并行发送多个请求和响应。
>    - 单个连接可以承载任意数量的双向数据流，单个连接上可以并行交错的请求和响应，之间互不干扰。
>    - 数据流以消息的形式发送，而消息又由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装。每个请求都可以带一个 31bit 的优先值，0 表示最高优先级， 数值越大优先级越低。

> - 帧（frame）和流（stream）：
>    - 帧：HTTP/2 中数据传输的最小单位，在 HTTP 2.0 中，它把数据报的两大部分分成了 header frame 和 data frame。也就是头部帧和数据体帧。
>    - 流： 存在于连接中的一个虚拟通道。流可以承载双向消息，每个流都有一个唯一的整数 ID。HTTP/2 长连接中的数据包是不按请求-响应顺序发送的，一个完整的请求或响应(称一个数据流 stream，每个数据流都有一个独一无二的编号)可能会分成非连续多次发送。它具有如下几个特点：
>       - 双向性：同一个流内，可同时发送和接受数据。
>       - 有序性：流中被传输的数据就是二进制帧 。帧在流上的被发送与被接收都是按照顺序进行的。
>       - 并行性：流中的 二进制帧 都是被并行传输的，无需按顺序等待。
>       - 流的创建：流可以被客户端或服务器单方面建立, 使用或共享。
>       - 流的关闭：流也可以被任意一方关闭。
>       - HEADERS 帧在 DATA 帧前面。
>       - 流的 ID 都是奇数，说明是由客户端发起的，这是标准规定的，那么服务端发起的就是偶数了

- 无状态：协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。（即给服务器发送请求，服务器应答后，不会记录任何信息）
   - Cookie：cookie的传递会经过下边这4步:
      - Client 发送 HTTP 请求给 Server
      - Server响应,并附带Set-Cookie的头部信息
      - Client保存 Cookie, 之后请求 Server 会附带Cookie的头部信息
      - Server从 Cookie 知道 Client是谁了,返回相应的响应
   - Session：如果把用户名、密码等重要隐私都存到客户端的Cookie中,还是有泄密风险。为了更安全,把机密信息保存到服务器上,这就是 Session Session是服务器上维护的客户档案,可以理解为服务器端数据库中有一张user表,里面存放了客户端的用户信息。SessionID就是这张表的主键ID。Session信息存到服务器,必然占用内存。用户多了以后,开销必然增大。为了提高效率,需要做分布式,做负载均衡。因为认证的信息保存在内存中,用户访问哪台服务器,下次还得访问相同这台服务器才能拿到授权信息,这就限制了负载均衡的能力。
   - Token：首先, Token不需要再存储用户信息,节约了内存。其次,由于不存储信息,客户端访问不同的服务器也能进行鉴权,增强了扩展能力。然后, Token可以采用不同的加密方式进行签名,提高了安全性。Token就是一段字符串, Token传递的过程跟 Cookie类似,只是传递对象变成了 Token。用户使用用户名、密码请求服务器后,服务器就生成 Token,在响应中返给客户端,客户端再次请求时附带上 Token, 服务器就用这个 Token进行认证鉴权。
[参考链接](https://blog.csdn.net/songxiao1124/article/details/120119388)

#### 代理服务器（proxy server）

- 代理服务器是一种网络实体，又称为万维网高速缓存（Web cache），代理服务器把最近的一些请求和响应暂存在本地磁盘中，当新请求到达时，若代理服务器发现这个请求和暂时存放的请求相同，则返回相应的回复。代理服务器可以在客户端或服务器端工作，也可以在中间系统工作
- 内容分发网络CDN（Content Distribute Network）：已代理服务器方式构成的网络
#### HTTP报文格式

- 请求报文

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663988424028-14612324-e78c-467f-84c4-b604048369df.jpeg#averageHue=%23f8f8f6&from=url&height=230&id=SyTCk&originHeight=551&originWidth=859&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90101&status=done&style=none&title=&width=358" width="358" /> </div>



- 响应报文

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1663988453539-7bf78538-a45a-4f43-8e12-b352d2e69928.jpeg#averageHue=%23f7f6f4&from=url&height=223&id=pfixz&originHeight=565&originWidth=758&originalType=binary&ratio=1&rotation=0&showTitle=false&size=95964&status=done&style=none&title=&width=299" width="299" /> </div>


## 电子邮件
### 电子邮件系统组成

- 用户代理UA（User Agent）：用户和电子邮件系统的接口
- 邮件服务器：按照客户服务器方式工作，接收和发送邮件同是报告邮件发送结果
- SMTP协议和POP3协议：使用TCP连接传送邮件（可靠的传送邮件），邮件不会在互联网中间的某个中间邮件服务器落地，而是直接建立起从当前服务器到目的服务器的TCP连接。SMTP负责发送邮件到目的邮件服务器，而POP3协议负责把要接收的邮件从当前邮件服务器下载到本地

<div align="center"> <img src="https://cdn.nlark.com/yuque/0/2022/jpeg/29674612/1664001170036-4505186f-f137-45c0-9595-1bff909dd381.jpeg#averageHue=%23f4f4f3&from=url&height=350&id=Zj2Za&originHeight=633&originWidth=976&originalType=binary&ratio=1&rotation=0&showTitle=false&size=157607&status=done&style=none&title=&width=540" width="540" /> </div>


### SMTP和POP3协议

- 简单邮件传送协议SMTP：规定了两个相互通信的SMTP协议进程之间应如何交换信息，至于邮件内部格式、邮件如何存储、邮件系统应该多快的速度发送邮件，SMTP未做出规定
   - 建立连接：
      1. 发送方的邮件上传到发送方的邮件服务器后，SMTP客户每隔一段时间就对邮件扫描一次，如发现邮件邮件就使用SMTP的熟知端口25和接收方邮件服务器建立TCP连接。
      2. 接收方发出“220 Server ready ”
      3. 发送方服务器发送HELO命令并附上发送方主机名。ESMTP使用EHLO命令，同时要求客户使用AUTH进行身份验证
      4. SMTP服务器如果有能力接收邮件就回复“250 OK”，否则“421 Server not available”
   - 邮件传送：










